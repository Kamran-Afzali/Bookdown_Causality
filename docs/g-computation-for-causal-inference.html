<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 11 G-Computation for Causal Inference | Causal Inference in R</title>
  <meta name="description" content="Chapter 11 G-Computation for Causal Inference | Causal Inference in R" />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 11 G-Computation for Causal Inference | Causal Inference in R" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 11 G-Computation for Causal Inference | Causal Inference in R" />
  
  
  

<meta name="author" content="Kamran Afzali" />


<meta name="date" content="2025-11-14" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html"/>
<link rel="next" href="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Causality analysis in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Foundations of Causal Statistical Analysis</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#summary-table-techniques-for-causal-statistical-analysis"><i class="fa fa-check"></i><b>1.2</b> Summary Table: Techniques for Causal Statistical Analysis</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#methodological-deep-dive-with-practical-guidance"><i class="fa fa-check"></i><b>1.3</b> Methodological Deep Dive with Practical Guidance</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#discussion"><i class="fa fa-check"></i><b>1.4</b> Discussion</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#references"><i class="fa fa-check"></i><b>1.5</b> References</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><i class="fa fa-check"></i><b>2</b> Causal Inference in Practice I: Randomized Controlled Trials and Regression Adjustment</a>
<ul>
<li class="chapter" data-level="2.1" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#randomized-controlled-trials-design-and-analysis"><i class="fa fa-check"></i><b>2.2</b> 1. Randomized Controlled Trials: Design and Analysis</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#theoretical-foundations"><i class="fa fa-check"></i><b>2.2.1</b> Theoretical Foundations</a></li>
<li class="chapter" data-level="2.2.2" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#r-implementation"><i class="fa fa-check"></i><b>2.2.2</b> R Implementation</a></li>
<li class="chapter" data-level="2.2.3" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#model-based-inference"><i class="fa fa-check"></i><b>2.2.3</b> Model-Based Inference</a></li>
<li class="chapter" data-level="2.2.4" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#diagnostics-and-integrity"><i class="fa fa-check"></i><b>2.2.4</b> Diagnostics and Integrity</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#regression-adjustment-a-model-based-approach-to-causal-inference"><i class="fa fa-check"></i><b>2.3</b> 2. Regression Adjustment: A Model-Based Approach to Causal Inference</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#conceptual-overview"><i class="fa fa-check"></i><b>2.3.1</b> Conceptual Overview</a></li>
<li class="chapter" data-level="2.3.2" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#r-implementation-1"><i class="fa fa-check"></i><b>2.3.2</b> R Implementation</a></li>
<li class="chapter" data-level="2.3.3" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#limitations-and-diagnostics"><i class="fa fa-check"></i><b>2.3.3</b> Limitations and Diagnostics</a></li>
<li class="chapter" data-level="2.3.4" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#causal-interpretation"><i class="fa fa-check"></i><b>2.3.4</b> Causal Interpretation</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#toward-integrated-reasoning"><i class="fa fa-check"></i><b>2.4</b> Toward Integrated Reasoning</a></li>
<li class="chapter" data-level="2.5" data-path="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html"><a href="causal-inference-in-practice-i-randomized-controlled-trials-and-regression-adjustment.html#conclusion"><i class="fa fa-check"></i><b>2.5</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html"><a href="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html"><i class="fa fa-check"></i><b>3</b> Causal Inference in Practice II: Propensity Scores, Doubly Robust Estimators, and Inverse Probability Weighting</a>
<ul>
<li class="chapter" data-level="3.1" data-path="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html"><a href="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html#propensity-score-methods"><i class="fa fa-check"></i><b>3.1</b> Propensity Score Methods</a></li>
<li class="chapter" data-level="3.2" data-path="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html"><a href="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html#inverse-probability-weighting-ipw"><i class="fa fa-check"></i><b>3.2</b> Inverse Probability Weighting (IPW)</a></li>
<li class="chapter" data-level="3.3" data-path="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html"><a href="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html#doubly-robust-estimators"><i class="fa fa-check"></i><b>3.3</b> Doubly Robust Estimators</a></li>
<li class="chapter" data-level="3.4" data-path="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html"><a href="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html#integrative-interpretation"><i class="fa fa-check"></i><b>3.4</b> Integrative Interpretation</a></li>
<li class="chapter" data-level="3.5" data-path="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html"><a href="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html#summary-table"><i class="fa fa-check"></i><b>3.5</b> Summary Table</a></li>
<li class="chapter" data-level="3.6" data-path="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html"><a href="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html#conclusion-1"><i class="fa fa-check"></i><b>3.6</b> Conclusion</a></li>
<li class="chapter" data-level="3.7" data-path="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html"><a href="causal-inference-in-practice-ii-propensity-scores-doubly-robust-estimators-and-inverse-probability-weighting.html#references-1"><i class="fa fa-check"></i><b>3.7</b> References</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><i class="fa fa-check"></i><b>4</b> Causal Inference in Practice III: Difference-in-Differences with a Healthcare Application</a>
<ul>
<li class="chapter" data-level="4.1" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html#introduction-2"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html#difference-in-differences-theoretical-framework"><i class="fa fa-check"></i><b>4.2</b> Difference-in-Differences: Theoretical Framework</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html#core-concept"><i class="fa fa-check"></i><b>4.2.1</b> Core Concept</a></li>
<li class="chapter" data-level="4.2.2" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html#mathematical-formalism"><i class="fa fa-check"></i><b>4.2.2</b> Mathematical Formalism</a></li>
<li class="chapter" data-level="4.2.3" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html#key-assumption-parallel-trends"><i class="fa fa-check"></i><b>4.2.3</b> Key Assumption: Parallel Trends</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html#application-evaluating-a-telemedicine-program-in-healthcare"><i class="fa fa-check"></i><b>4.3</b> Application: Evaluating a Telemedicine Program in Healthcare</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html#r-implementation-2"><i class="fa fa-check"></i><b>4.3.1</b> R Implementation</a></li>
<li class="chapter" data-level="4.3.2" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html#limitations-and-takeaways"><i class="fa fa-check"></i><b>4.3.2</b> Limitations and takeaways</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html#conclusion-2"><i class="fa fa-check"></i><b>4.4</b> Conclusion</a></li>
<li class="chapter" data-level="4.5" data-path="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html"><a href="causal-inference-in-practice-iii-difference-in-differences-with-a-healthcare-application.html#references-2"><i class="fa fa-check"></i><b>4.5</b> References</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html"><i class="fa fa-check"></i><b>5</b> Causal Inference in Practice IV: Instrumental Variables</a>
<ul>
<li class="chapter" data-level="5.1" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html#introduction-3"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html#healthcare-case-study-hospital-quality-and-recovery-time"><i class="fa fa-check"></i><b>5.2</b> Healthcare Case Study: Hospital Quality and Recovery Time</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html#r-implementation-3"><i class="fa fa-check"></i><b>5.2.1</b> R Implementation</a></li>
<li class="chapter" data-level="5.2.2" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html#interpreting-the-results"><i class="fa fa-check"></i><b>5.2.2</b> Interpreting the Results</a></li>
<li class="chapter" data-level="5.2.3" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html#robustness-checks"><i class="fa fa-check"></i><b>5.2.3</b> Robustness Checks</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html#practical-considerations-and-extensions"><i class="fa fa-check"></i><b>5.3</b> Practical Considerations and Extensions</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html#when-to-use-iv"><i class="fa fa-check"></i><b>5.3.1</b> When to Use IV</a></li>
<li class="chapter" data-level="5.3.2" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html#advanced-topics"><i class="fa fa-check"></i><b>5.3.2</b> Advanced Topics</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html#conclusion-3"><i class="fa fa-check"></i><b>5.4</b> Conclusion</a></li>
<li class="chapter" data-level="5.5" data-path="causal-inference-in-practice-iv-instrumental-variables.html"><a href="causal-inference-in-practice-iv-instrumental-variables.html#further-reading"><i class="fa fa-check"></i><b>5.5</b> Further Reading</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html"><i class="fa fa-check"></i><b>6</b> Causal Inference in Practice V: Regression Discontinuity Design</a>
<ul>
<li class="chapter" data-level="6.1" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#introduction-4"><i class="fa fa-check"></i><b>6.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#comparison-with-other-methods"><i class="fa fa-check"></i><b>6.1.1</b> Comparison with Other Methods</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#healthcare-application-icu-admission-and-mortality"><i class="fa fa-check"></i><b>6.2</b> Healthcare Application: ICU Admission and Mortality</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#scenario"><i class="fa fa-check"></i><b>6.2.1</b> Scenario</a></li>
<li class="chapter" data-level="6.2.2" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#assumptions-and-validity"><i class="fa fa-check"></i><b>6.2.2</b> Assumptions and Validity</a></li>
<li class="chapter" data-level="6.2.3" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#r-implementation-4"><i class="fa fa-check"></i><b>6.2.3</b> R Implementation</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#interpretation-and-diagnostics"><i class="fa fa-check"></i><b>6.3</b> Interpretation and Diagnostics</a></li>
<li class="chapter" data-level="6.4" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#extensions-and-robustness"><i class="fa fa-check"></i><b>6.4</b> Extensions and Robustness</a></li>
<li class="chapter" data-level="6.5" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#limitations-and-considerations"><i class="fa fa-check"></i><b>6.5</b> Limitations and Considerations</a></li>
<li class="chapter" data-level="6.6" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#conclusion-4"><i class="fa fa-check"></i><b>6.6</b> Conclusion</a></li>
<li class="chapter" data-level="6.7" data-path="causal-inference-in-practice-v-regression-discontinuity-design.html"><a href="causal-inference-in-practice-v-regression-discontinuity-design.html#references-3"><i class="fa fa-check"></i><b>6.7</b> References</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="causal-forests.html"><a href="causal-forests.html"><i class="fa fa-check"></i><b>7</b> Causal Forests</a>
<ul>
<li class="chapter" data-level="7.1" data-path="causal-forests.html"><a href="causal-forests.html#introduction-5"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="causal-forests.html"><a href="causal-forests.html#precision-medicine-case-study-personalized-diabetes-treatment"><i class="fa fa-check"></i><b>7.2</b> Precision Medicine Case Study: Personalized Diabetes Treatment</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="causal-forests.html"><a href="causal-forests.html#data-generation-and-setup"><i class="fa fa-check"></i><b>7.2.1</b> Data Generation and Setup</a></li>
<li class="chapter" data-level="7.2.2" data-path="causal-forests.html"><a href="causal-forests.html#fitting-the-causal-forest"><i class="fa fa-check"></i><b>7.2.2</b> Fitting the Causal Forest</a></li>
<li class="chapter" data-level="7.2.3" data-path="causal-forests.html"><a href="causal-forests.html#variable-importance-analysis"><i class="fa fa-check"></i><b>7.2.3</b> Variable Importance Analysis</a></li>
<li class="chapter" data-level="7.2.4" data-path="causal-forests.html"><a href="causal-forests.html#statistical-testing-for-heterogeneity"><i class="fa fa-check"></i><b>7.2.4</b> Statistical Testing for Heterogeneity</a></li>
<li class="chapter" data-level="7.2.5" data-path="causal-forests.html"><a href="causal-forests.html#visualization-and-pattern-discovery"><i class="fa fa-check"></i><b>7.2.5</b> Visualization and Pattern Discovery</a></li>
<li class="chapter" data-level="7.2.6" data-path="causal-forests.html"><a href="causal-forests.html#personalized-treatment-strategy-development"><i class="fa fa-check"></i><b>7.2.6</b> Personalized Treatment Strategy Development</a></li>
<li class="chapter" data-level="7.2.7" data-path="causal-forests.html"><a href="causal-forests.html#partial-dependence-analysis"><i class="fa fa-check"></i><b>7.2.7</b> Partial Dependence Analysis</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="causal-forests.html"><a href="causal-forests.html#clinical-insights-and-limitations"><i class="fa fa-check"></i><b>7.3</b> Clinical Insights and Limitations</a></li>
<li class="chapter" data-level="7.4" data-path="causal-forests.html"><a href="causal-forests.html#conclusion-5"><i class="fa fa-check"></i><b>7.4</b> Conclusion</a></li>
<li class="chapter" data-level="7.5" data-path="causal-forests.html"><a href="causal-forests.html#references-4"><i class="fa fa-check"></i><b>7.5</b> References</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="bayesian-structural-time-series-for-causal-inference.html"><a href="bayesian-structural-time-series-for-causal-inference.html"><i class="fa fa-check"></i><b>8</b> Bayesian Structural Time Series for Causal Inference</a>
<ul>
<li class="chapter" data-level="8.1" data-path="bayesian-structural-time-series-for-causal-inference.html"><a href="bayesian-structural-time-series-for-causal-inference.html#introduction-6"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
<li class="chapter" data-level="8.2" data-path="bayesian-structural-time-series-for-causal-inference.html"><a href="bayesian-structural-time-series-for-causal-inference.html#r-implementation-examples-healthcare"><i class="fa fa-check"></i><b>8.2</b> R Implementation examples Healthcare</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="bayesian-structural-time-series-for-causal-inference.html"><a href="bayesian-structural-time-series-for-causal-inference.html#tobacco-tax-policy"><i class="fa fa-check"></i><b>8.2.1</b> Tobacco Tax Policy</a></li>
<li class="chapter" data-level="8.2.2" data-path="bayesian-structural-time-series-for-causal-inference.html"><a href="bayesian-structural-time-series-for-causal-inference.html#teletherapy-program-assessment"><i class="fa fa-check"></i><b>8.2.2</b> Teletherapy Program Assessment</a></li>
<li class="chapter" data-level="8.2.3" data-path="bayesian-structural-time-series-for-causal-inference.html"><a href="bayesian-structural-time-series-for-causal-inference.html#implementation-guidelines-for-healthcare-applications"><i class="fa fa-check"></i><b>8.2.3</b> Implementation Guidelines for Healthcare Applications</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="bayesian-structural-time-series-for-causal-inference.html"><a href="bayesian-structural-time-series-for-causal-inference.html#conclusion-6"><i class="fa fa-check"></i><b>8.3</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html"><i class="fa fa-check"></i><b>9</b> Meta-Learners for Heterogeneous Treatment Effects</a>
<ul>
<li class="chapter" data-level="9.1" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#introduction-the-promise-and-peril-of-machine-learning-for-causal-inference"><i class="fa fa-check"></i><b>9.1</b> Introduction: The Promise and Peril of Machine Learning for Causal Inference</a></li>
<li class="chapter" data-level="9.2" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#theoretical-foundation-from-prediction-to-causal-inference"><i class="fa fa-check"></i><b>9.2</b> Theoretical Foundation: From Prediction to Causal Inference</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#the-s-learner-simplicity-with-hidden-complexity"><i class="fa fa-check"></i><b>9.2.1</b> The S-Learner: Simplicity with Hidden Complexity</a></li>
<li class="chapter" data-level="9.2.2" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#the-t-learner-divide-and-conquer"><i class="fa fa-check"></i><b>9.2.2</b> The T-Learner: Divide and Conquer</a></li>
<li class="chapter" data-level="9.2.3" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#the-x-learner-sophisticated-synthesis"><i class="fa fa-check"></i><b>9.2.3</b> The X-Learner: Sophisticated Synthesis</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#practical-implementation-hypertension-treatment-optimization"><i class="fa fa-check"></i><b>9.3</b> Practical Implementation: Hypertension Treatment Optimization</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#implementing-the-s-learner"><i class="fa fa-check"></i><b>9.3.1</b> Implementing the S-Learner</a></li>
<li class="chapter" data-level="9.3.2" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#implementing-the-t-learner"><i class="fa fa-check"></i><b>9.3.2</b> Implementing the T-Learner</a></li>
<li class="chapter" data-level="9.3.3" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#implementing-the-x-learner"><i class="fa fa-check"></i><b>9.3.3</b> Implementing the X-Learner</a></li>
<li class="chapter" data-level="9.3.4" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#comparative-analysis-and-model-selection"><i class="fa fa-check"></i><b>9.3.4</b> Comparative Analysis and Model Selection</a></li>
<li class="chapter" data-level="9.3.5" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#clinical-pattern-discovery-and-interpretation"><i class="fa fa-check"></i><b>9.3.5</b> Clinical Pattern Discovery and Interpretation</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#implementation-considerations-and-best-practices"><i class="fa fa-check"></i><b>9.4</b> Implementation Considerations and Best Practices</a></li>
<li class="chapter" data-level="9.5" data-path="meta-learners-for-heterogeneous-treatment-effects.html"><a href="meta-learners-for-heterogeneous-treatment-effects.html#conclusion-democratizing-causal-machine-learning"><i class="fa fa-check"></i><b>9.5</b> Conclusion: Democratizing Causal Machine Learning</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html"><a href="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html"><i class="fa fa-check"></i><b>10</b> Targeted Maximum Likelihood Estimation for Robust Causal Inference in Healthcare</a>
<ul>
<li class="chapter" data-level="10.1" data-path="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html"><a href="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html#introduction-7"><i class="fa fa-check"></i><b>10.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html"><a href="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html#double-robustness-and-tmle"><i class="fa fa-check"></i><b>10.1.1</b> Double Robustness and TMLE</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html"><a href="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html#healthcare-application-comparative-effectiveness-of-hypertension-treatments"><i class="fa fa-check"></i><b>10.2</b> Healthcare Application: Comparative Effectiveness of Hypertension Treatments</a></li>
<li class="chapter" data-level="10.3" data-path="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html"><a href="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html#limitations-and-practical-implementation"><i class="fa fa-check"></i><b>10.3</b> Limitations and Practical Implementation</a></li>
<li class="chapter" data-level="10.4" data-path="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html"><a href="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html#conclusion-7"><i class="fa fa-check"></i><b>10.4</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="g-computation-for-causal-inference.html"><a href="g-computation-for-causal-inference.html"><i class="fa fa-check"></i><b>11</b> G-Computation for Causal Inference</a>
<ul>
<li class="chapter" data-level="11.1" data-path="g-computation-for-causal-inference.html"><a href="g-computation-for-causal-inference.html#introduction-8"><i class="fa fa-check"></i><b>11.1</b> Introduction</a></li>
<li class="chapter" data-level="11.2" data-path="g-computation-for-causal-inference.html"><a href="g-computation-for-causal-inference.html#case-study-hypertension-management-over-time"><i class="fa fa-check"></i><b>11.2</b> Case Study: Hypertension Management Over Time</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="g-computation-for-causal-inference.html"><a href="g-computation-for-causal-inference.html#fitting-the-g-formula-model"><i class="fa fa-check"></i><b>11.2.1</b> Fitting the G-Formula Model</a></li>
<li class="chapter" data-level="11.2.2" data-path="g-computation-for-causal-inference.html"><a href="g-computation-for-causal-inference.html#interpreting-results-and-model-diagnostics"><i class="fa fa-check"></i><b>11.2.2</b> Interpreting Results and Model Diagnostics</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="g-computation-for-causal-inference.html"><a href="g-computation-for-causal-inference.html#practical-considerations-and-limitations"><i class="fa fa-check"></i><b>11.3</b> Practical Considerations and Limitations</a></li>
<li class="chapter" data-level="11.4" data-path="g-computation-for-causal-inference.html"><a href="g-computation-for-causal-inference.html#conclusion-integrating-g-computation-into-practice"><i class="fa fa-check"></i><b>11.4</b> Conclusion: Integrating G-Computation into Practice</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html"><a href="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html"><i class="fa fa-check"></i><b>12</b> Structural Equation Modeling for Healthcare Research: Unraveling Complex Causal Pathways</a>
<ul>
<li class="chapter" data-level="12.1" data-path="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html"><a href="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html#introduction-9"><i class="fa fa-check"></i><b>12.1</b> Introduction</a></li>
<li class="chapter" data-level="12.2" data-path="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html"><a href="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html#a-mediation-analysis-physical-activity-mental-health-and-diabetes-control"><i class="fa fa-check"></i><b>12.2</b> A Mediation Analysis: Physical Activity, Mental Health, and Diabetes Control</a></li>
<li class="chapter" data-level="12.3" data-path="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html"><a href="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html#clinical-interpretation-and-limitations"><i class="fa fa-check"></i><b>12.3</b> Clinical Interpretation and Limitations</a></li>
<li class="chapter" data-level="12.4" data-path="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html"><a href="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html#conclusion-8"><i class="fa fa-check"></i><b>12.4</b> Conclusion</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Causal Inference in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="g-computation-for-causal-inference" class="section level1 hasAnchor" number="11">
<h1><span class="header-section-number">Chapter 11</span> G-Computation for Causal Inference<a href="g-computation-for-causal-inference.html#g-computation-for-causal-inference" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction-8" class="section level2 hasAnchor" number="11.1">
<h2><span class="header-section-number">11.1</span> Introduction<a href="g-computation-for-causal-inference.html#introduction-8" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A 55-year-old patient with hypertension visits your clinic. She’s currently on first-line antihypertensive medication, and you’re considering adding a statin for cardiovascular protection. But the decision isn’t straightforward—you need to consider not just the direct effect of the statin, but also how it might interact with her blood pressure medication, how her treatment adherence might change, and what her cardiovascular risk would look like over the next decade under different treatment strategies. Traditional clinical trial results provide average effects for populations that may not match your patient’s complex profile and treatment history.</p>
<p>This is where G-computation, one of the most powerful yet underutilized tools in causal inference, becomes invaluable. Developed by Jamie Robins in the 1980s, G-computation provides a general framework for estimating causal effects from observational data by explicitly modeling the data-generating process and using those models to simulate counterfactual outcomes under different treatment regimes. Unlike propensity score methods that focus on modeling treatment assignment, G-computation directly models the outcome process, enabling estimation of effects in complex longitudinal settings with time-varying treatments and confounders.</p>
<p>The method’s name derives from the “G-formula,” a mathematical expression that standardizes over the distribution of confounders to obtain marginal causal effects. While the theory can appear daunting, the core intuition is remarkably straightforward: if we can build good models of how treatments affect outcomes while accounting for confounding, we can use those models to predict what would have happened under different treatment strategies. By comparing predictions under different scenarios, we recover causal effects without requiring the strong parametric assumptions of traditional regression adjustment.</p>
<p>G-computation excels in several scenarios where other causal methods struggle. It handles time-varying treatments where treatment decisions at one time point depend on previous outcomes, a common pattern in chronic disease management where clinicians adjust medications based on evolving patient status. The method naturally accommodates mediation analysis by allowing explicit modeling of intermediate variables on the causal pathway between treatment and outcome. It provides estimates of both conditional effects for specific patient profiles and marginal effects averaged over population characteristics, offering flexibility that matches diverse research questions. Perhaps most importantly, G-computation enables estimation of effects under complex dynamic treatment regimes that would be impossible or unethical to study in randomized trials.</p>
<p>The theoretical foundation of G-computation rests on the potential outcomes framework and Pearl’s do-calculus, providing a rigorous basis for translating observational associations into causal statements. Consider a simple setting with treatment <span class="math inline">\(A\)</span>, outcome <span class="math inline">\(Y\)</span>, and baseline confounders <span class="math inline">\(L\)</span>. Under the potential outcomes framework, each individual has potential outcomes <span class="math inline">\(Y^{a}\)</span> representing what their outcome would be if they received treatment level <span class="math inline">\(a\)</span>. The causal effect of treatment versus control is <span class="math inline">\(\mathbb{E}[Y^{1} - Y^{0}]\)</span>, but we face the fundamental problem of causal inference: we only observe <span class="math inline">\(Y^{A}\)</span>, the outcome under the treatment actually received.</p>
<p>The G-formula provides the key to identification under exchangeability, also known as unconfoundedness or no unmeasured confounding. This assumption states that conditional on measured confounders <span class="math inline">\(L\)</span>, treatment assignment is independent of potential outcomes: <span class="math inline">\(Y^{a} \perp A \mid L\)</span> for all <span class="math inline">\(a\)</span>. Additionally, we require positivity, ensuring that every individual has positive probability of receiving each treatment level given their confounder values: <span class="math inline">\(P(A = a \mid L = l) &gt; 0\)</span> for all relevant <span class="math inline">\(a\)</span> and <span class="math inline">\(l\)</span>. Under these assumptions, the G-formula expresses the marginal mean of the potential outcome as <span class="math inline">\(\mathbb{E}[Y^{a}] = \sum_{l} \mathbb{E}[Y \mid A = a, L = l] \cdot P(L = l)\)</span>.</p>
<p>This formula has an elegant interpretation: to compute the average outcome if everyone received treatment <span class="math inline">\(a\)</span>, we first calculate the expected outcome for each confounder pattern under treatment <span class="math inline">\(a\)</span>, then average over the actual distribution of confounders in the population. This standardization removes confounding by making treatment groups comparable with respect to confounder distributions. The causal effect becomes the difference between these standardized means under different treatment values: <span class="math inline">\(\mathbb{E}[Y^{1}] - \mathbb{E}[Y^{0}]\)</span>.</p>
<p>The G-formula extends naturally to longitudinal settings with time-varying treatments and confounders, where treatment history affects future confounders which in turn affect future treatment decisions. This creates time-dependent confounding that violates the assumptions of standard regression adjustment. Consider a sequence of treatment decisions <span class="math inline">\(A_0, A_1, \ldots, A_K\)</span> and time-varying confounders <span class="math inline">\(L_0, L_1, \ldots, L_K\)</span> measured before each treatment decision, with final outcome <span class="math inline">\(Y\)</span> measured at time <span class="math inline">\(K+1\)</span>. The longitudinal G-formula for a treatment regime <span class="math inline">\(\bar{a} = (a_0, a_1, \ldots, a_K)\)</span> becomes</p>
<p><span class="math display">\[\mathbb{E}[Y^{\bar{a}}] = \sum_{\bar{l}} \mathbb{E}[Y \mid \bar{A} = \bar{a}, \bar{L} = \bar{l}] \prod_{k=0}^{K} P(L_k = l_k \mid \bar{A}_{k-1} = \bar{a}_{k-1}, \bar{L}_{k-1} = \bar{l}_{k-1})\]</span></p>
<p>This formidable expression captures the sequential nature of longitudinal data where past treatments and confounders affect future covariate evolution. The formula marginalizes over all possible confounder trajectories, weighting each by its probability under the treatment regime of interest. While exact calculation requires summing over all possible covariate histories (computationally infeasible in practice), we can approximate this expectation through parametric modeling and Monte Carlo simulation.</p>
<p>The parametric G-formula algorithm translates the mathematical formula into a practical computational procedure through three essential steps: model specification, Monte Carlo simulation, and effect estimation. This approach requires specifying parametric models for how treatments affect outcomes and how treatments and past history affect future confounders, then using these models to simulate counterfactual trajectories under different treatment regimes.</p>
<p>In the model specification phase, we construct separate regression models for each time-varying component. For the outcome, we model <span class="math inline">\(\mathbb{E}[Y \mid \bar{A}, \bar{L}]\)</span> as a function of treatment history and confounder history, typically using generalized linear models appropriate to the outcome type. For each time-varying confounder <span class="math inline">\(L_k\)</span>, we model <span class="math inline">\(P(L_k \mid \bar{A}_{k-1}, \bar{L}_{k-1})\)</span> capturing how previous treatments and covariates affect future covariate values. These models embody our understanding of the data-generating process and need not be correct in all details—they must simply capture the relationships between treatments, confounders, and outcomes accurately enough to provide unbiased effect estimates.</p>
<p>The Monte Carlo simulation phase generates counterfactual datasets under different treatment regimes. Starting with the observed baseline covariates <span class="math inline">\(L_0\)</span> for each individual, we simulate forward in time by first assigning the specified treatment value <span class="math inline">\(a_0\)</span>, then using the fitted confounder models to simulate <span class="math inline">\(L_1\)</span> given <span class="math inline">\(a_0\)</span> and <span class="math inline">\(L_0\)</span>, continuing this process through all time points. For each treatment regime of interest, this process generates a complete counterfactual dataset where every individual follows the same treatment strategy. By simulating the natural evolution of confounders under each treatment regime, we create synthetic comparison groups that would be exchangeable in a randomized trial.</p>
<p>Finally, we estimate the outcome under each regime by fitting the outcome model to each simulated dataset and averaging predictions across all individuals. The causal effect emerges from comparing these regime-specific outcome estimates. Confidence intervals accounting for both sampling variability and model estimation uncertainty require bootstrap resampling, where we repeat the entire procedure on bootstrap samples of the original data to quantify estimation uncertainty.</p>
</div>
<div id="case-study-hypertension-management-over-time" class="section level2 hasAnchor" number="11.2">
<h2><span class="header-section-number">11.2</span> Case Study: Hypertension Management Over Time<a href="g-computation-for-causal-inference.html#case-study-hypertension-management-over-time" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We’ll explore G-computation through a realistic scenario involving management of hypertension with time-varying treatment intensity and evolving cardiovascular risk. Our goal is to estimate the effect of sustained intensive blood pressure control versus standard control on five-year cardiovascular event risk, accounting for treatment adjustments based on evolving patient status.</p>
<p>This simulation captures realistic features of hypertension management including treatment intensification based on blood pressure levels and risk factors, imperfect adherence that affects treatment effectiveness, blood pressure evolution depending on treatment and adherence patterns, and cardiovascular events influenced by current blood pressure, treatment, and baseline risk factors. The time-dependent confounding emerges naturally as blood pressure at time <span class="math inline">\(t\)</span> affects treatment decisions at time <span class="math inline">\(t\)</span> and outcomes at time <span class="math inline">\(t+1\)</span>, while past treatment affects current blood pressure.</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="g-computation-for-causal-inference.html#cb330-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;data.table&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;data.table&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: data.table</code></pre>
<pre><code>## data.table 1.17.0 using 1 threads (see ?getDTthreads).  Latest news: r-datatable.com
## **********
## This installation of data.table has not detected OpenMP support. It should still work but in single-threaded mode.
## This is a Mac. Please read https://mac.r-project.org/openmp/. Please engage with Apple and ask them for support. Check r-datatable.com for updates, and our Mac instructions here: https://github.com/Rdatatable/data.table/wiki/Installation. After several years of many reports of installation problems on Mac, it&#39;s time to gingerly point out that there have been no similar problems on Windows or Linux.
## **********
## 
## Attaching package: &#39;data.table&#39;
## 
## The following objects are masked from &#39;package:xts&#39;:
## 
##     first, last
## 
## The following objects are masked from &#39;package:reshape2&#39;:
## 
##     dcast, melt
## 
## The following objects are masked from &#39;package:zoo&#39;:
## 
##     yearmon, yearqtr
## 
## The following objects are masked from &#39;package:lubridate&#39;:
## 
##     hour, isoweek, mday, minute, month, quarter, second, wday, week, yday, year
## 
## The following objects are masked from &#39;package:dplyr&#39;:
## 
##     between, first, last
## 
## The following object is masked from &#39;package:purrr&#39;:
## 
##     transpose</code></pre>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb333-1"><a href="g-computation-for-causal-inference.html#cb333-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;ggplot2&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb333-2"><a href="g-computation-for-causal-inference.html#cb333-2" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;dplyr&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;dplyr&quot;</span>)</span>
<span id="cb333-3"><a href="g-computation-for-causal-inference.html#cb333-3" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;betareg&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;betareg&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: betareg</code></pre>
<pre><code>## Warning: package &#39;betareg&#39; was built under R version 4.5.1</code></pre>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="g-computation-for-causal-inference.html#cb336-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;survival&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;survival&quot;</span>)</span>
<span id="cb336-2"><a href="g-computation-for-causal-inference.html#cb336-2" tabindex="-1"></a></span>
<span id="cb336-3"><a href="g-computation-for-causal-inference.html#cb336-3" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb336-4"><a href="g-computation-for-causal-inference.html#cb336-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb336-5"><a href="g-computation-for-causal-inference.html#cb336-5" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb336-6"><a href="g-computation-for-causal-inference.html#cb336-6" tabindex="-1"></a><span class="fu">library</span>(betareg)</span>
<span id="cb336-7"><a href="g-computation-for-causal-inference.html#cb336-7" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb336-8"><a href="g-computation-for-causal-inference.html#cb336-8" tabindex="-1"></a></span>
<span id="cb336-9"><a href="g-computation-for-causal-inference.html#cb336-9" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb336-10"><a href="g-computation-for-causal-inference.html#cb336-10" tabindex="-1"></a></span>
<span id="cb336-11"><a href="g-computation-for-causal-inference.html#cb336-11" tabindex="-1"></a></span>
<span id="cb336-12"><a href="g-computation-for-causal-inference.html#cb336-12" tabindex="-1"></a>simulate_hypertension_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">time_points =</span> <span class="dv">6</span>) {</span>
<span id="cb336-13"><a href="g-computation-for-causal-inference.html#cb336-13" tabindex="-1"></a>  </span>
<span id="cb336-14"><a href="g-computation-for-causal-inference.html#cb336-14" tabindex="-1"></a>  <span class="co"># Baseline characteristics</span></span>
<span id="cb336-15"><a href="g-computation-for-causal-inference.html#cb336-15" tabindex="-1"></a>  baseline <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb336-16"><a href="g-computation-for-causal-inference.html#cb336-16" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb336-17"><a href="g-computation-for-causal-inference.html#cb336-17" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">rnorm</span>(n, <span class="dv">55</span>, <span class="dv">8</span>),</span>
<span id="cb336-18"><a href="g-computation-for-causal-inference.html#cb336-18" tabindex="-1"></a>    <span class="at">diabetes =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.3</span>),</span>
<span id="cb336-19"><a href="g-computation-for-causal-inference.html#cb336-19" tabindex="-1"></a>    <span class="at">smoking =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.25</span>),</span>
<span id="cb336-20"><a href="g-computation-for-causal-inference.html#cb336-20" tabindex="-1"></a>    <span class="at">baseline_sbp =</span> <span class="fu">rnorm</span>(n, <span class="dv">145</span>, <span class="dv">15</span>)</span>
<span id="cb336-21"><a href="g-computation-for-causal-inference.html#cb336-21" tabindex="-1"></a>  )</span>
<span id="cb336-22"><a href="g-computation-for-causal-inference.html#cb336-22" tabindex="-1"></a>  </span>
<span id="cb336-23"><a href="g-computation-for-causal-inference.html#cb336-23" tabindex="-1"></a>  <span class="co"># Pre-allocate list with proper size</span></span>
<span id="cb336-24"><a href="g-computation-for-causal-inference.html#cb336-24" tabindex="-1"></a>  long_data <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>, n)</span>
<span id="cb336-25"><a href="g-computation-for-causal-inference.html#cb336-25" tabindex="-1"></a>  </span>
<span id="cb336-26"><a href="g-computation-for-causal-inference.html#cb336-26" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb336-27"><a href="g-computation-for-causal-inference.html#cb336-27" tabindex="-1"></a>    <span class="co"># Individual baseline values</span></span>
<span id="cb336-28"><a href="g-computation-for-causal-inference.html#cb336-28" tabindex="-1"></a>    sbp <span class="ot">&lt;-</span> baseline<span class="sc">$</span>baseline_sbp[i]</span>
<span id="cb336-29"><a href="g-computation-for-causal-inference.html#cb336-29" tabindex="-1"></a>    treatment <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb336-30"><a href="g-computation-for-causal-inference.html#cb336-30" tabindex="-1"></a>    adherence <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb336-31"><a href="g-computation-for-causal-inference.html#cb336-31" tabindex="-1"></a>    </span>
<span id="cb336-32"><a href="g-computation-for-causal-inference.html#cb336-32" tabindex="-1"></a>    <span class="co"># Pre-allocate data frame</span></span>
<span id="cb336-33"><a href="g-computation-for-causal-inference.html#cb336-33" tabindex="-1"></a>    individual_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb336-34"><a href="g-computation-for-causal-inference.html#cb336-34" tabindex="-1"></a>      <span class="at">id =</span> <span class="fu">rep</span>(baseline<span class="sc">$</span>id[i], time_points),</span>
<span id="cb336-35"><a href="g-computation-for-causal-inference.html#cb336-35" tabindex="-1"></a>      <span class="at">time =</span> <span class="dv">0</span><span class="sc">:</span>(time_points <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb336-36"><a href="g-computation-for-causal-inference.html#cb336-36" tabindex="-1"></a>      <span class="at">age =</span> <span class="fu">rep</span>(baseline<span class="sc">$</span>age[i], time_points),</span>
<span id="cb336-37"><a href="g-computation-for-causal-inference.html#cb336-37" tabindex="-1"></a>      <span class="at">diabetes =</span> <span class="fu">rep</span>(baseline<span class="sc">$</span>diabetes[i], time_points),</span>
<span id="cb336-38"><a href="g-computation-for-causal-inference.html#cb336-38" tabindex="-1"></a>      <span class="at">smoking =</span> <span class="fu">rep</span>(baseline<span class="sc">$</span>smoking[i], time_points),</span>
<span id="cb336-39"><a href="g-computation-for-causal-inference.html#cb336-39" tabindex="-1"></a>      <span class="at">sbp =</span> <span class="fu">numeric</span>(time_points),</span>
<span id="cb336-40"><a href="g-computation-for-causal-inference.html#cb336-40" tabindex="-1"></a>      <span class="at">treatment =</span> <span class="fu">numeric</span>(time_points),</span>
<span id="cb336-41"><a href="g-computation-for-causal-inference.html#cb336-41" tabindex="-1"></a>      <span class="at">adherence =</span> <span class="fu">numeric</span>(time_points),</span>
<span id="cb336-42"><a href="g-computation-for-causal-inference.html#cb336-42" tabindex="-1"></a>      <span class="at">cvd_event =</span> <span class="fu">numeric</span>(time_points),</span>
<span id="cb336-43"><a href="g-computation-for-causal-inference.html#cb336-43" tabindex="-1"></a>      <span class="at">event_time =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, time_points)</span>
<span id="cb336-44"><a href="g-computation-for-causal-inference.html#cb336-44" tabindex="-1"></a>    )</span>
<span id="cb336-45"><a href="g-computation-for-causal-inference.html#cb336-45" tabindex="-1"></a>    </span>
<span id="cb336-46"><a href="g-computation-for-causal-inference.html#cb336-46" tabindex="-1"></a>    cvd_event_occurred <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb336-47"><a href="g-computation-for-causal-inference.html#cb336-47" tabindex="-1"></a>    event_time <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb336-48"><a href="g-computation-for-causal-inference.html#cb336-48" tabindex="-1"></a>    </span>
<span id="cb336-49"><a href="g-computation-for-causal-inference.html#cb336-49" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>(time_points <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb336-50"><a href="g-computation-for-causal-inference.html#cb336-50" tabindex="-1"></a>      <span class="co"># Record current state</span></span>
<span id="cb336-51"><a href="g-computation-for-causal-inference.html#cb336-51" tabindex="-1"></a>      individual_data<span class="sc">$</span>sbp[t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> sbp</span>
<span id="cb336-52"><a href="g-computation-for-causal-inference.html#cb336-52" tabindex="-1"></a>      individual_data<span class="sc">$</span>treatment[t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> treatment</span>
<span id="cb336-53"><a href="g-computation-for-causal-inference.html#cb336-53" tabindex="-1"></a>      individual_data<span class="sc">$</span>adherence[t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> adherence</span>
<span id="cb336-54"><a href="g-computation-for-causal-inference.html#cb336-54" tabindex="-1"></a>      </span>
<span id="cb336-55"><a href="g-computation-for-causal-inference.html#cb336-55" tabindex="-1"></a>      <span class="co"># CVD event (incident event only)</span></span>
<span id="cb336-56"><a href="g-computation-for-causal-inference.html#cb336-56" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span>cvd_event_occurred) {</span>
<span id="cb336-57"><a href="g-computation-for-causal-inference.html#cb336-57" tabindex="-1"></a>        event_prob <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">8</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> sbp <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> baseline<span class="sc">$</span>age[i] <span class="sc">+</span> </span>
<span id="cb336-58"><a href="g-computation-for-causal-inference.html#cb336-58" tabindex="-1"></a>                               <span class="fl">0.8</span> <span class="sc">*</span> baseline<span class="sc">$</span>diabetes[i] <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> baseline<span class="sc">$</span>smoking[i] <span class="sc">-</span> </span>
<span id="cb336-59"><a href="g-computation-for-causal-inference.html#cb336-59" tabindex="-1"></a>                               <span class="fl">0.5</span> <span class="sc">*</span> treatment <span class="sc">*</span> adherence)</span>
<span id="cb336-60"><a href="g-computation-for-causal-inference.html#cb336-60" tabindex="-1"></a>        cvd_event_occurred <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, event_prob) <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb336-61"><a href="g-computation-for-causal-inference.html#cb336-61" tabindex="-1"></a>        </span>
<span id="cb336-62"><a href="g-computation-for-causal-inference.html#cb336-62" tabindex="-1"></a>        <span class="cf">if</span> (cvd_event_occurred) {</span>
<span id="cb336-63"><a href="g-computation-for-causal-inference.html#cb336-63" tabindex="-1"></a>          event_time <span class="ot">&lt;-</span> t</span>
<span id="cb336-64"><a href="g-computation-for-causal-inference.html#cb336-64" tabindex="-1"></a>        }</span>
<span id="cb336-65"><a href="g-computation-for-causal-inference.html#cb336-65" tabindex="-1"></a>      }</span>
<span id="cb336-66"><a href="g-computation-for-causal-inference.html#cb336-66" tabindex="-1"></a>      </span>
<span id="cb336-67"><a href="g-computation-for-causal-inference.html#cb336-67" tabindex="-1"></a>      <span class="co"># Record event (incident, not absorbing state for modeling)</span></span>
<span id="cb336-68"><a href="g-computation-for-causal-inference.html#cb336-68" tabindex="-1"></a>      individual_data<span class="sc">$</span>cvd_event[t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(cvd_event_occurred <span class="sc">&amp;&amp;</span> t <span class="sc">==</span> event_time)</span>
<span id="cb336-69"><a href="g-computation-for-causal-inference.html#cb336-69" tabindex="-1"></a>      individual_data<span class="sc">$</span>event_time[t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> event_time</span>
<span id="cb336-70"><a href="g-computation-for-causal-inference.html#cb336-70" tabindex="-1"></a>      </span>
<span id="cb336-71"><a href="g-computation-for-causal-inference.html#cb336-71" tabindex="-1"></a>      <span class="co"># Update variables for next time point</span></span>
<span id="cb336-72"><a href="g-computation-for-causal-inference.html#cb336-72" tabindex="-1"></a>      <span class="cf">if</span> (t <span class="sc">&lt;</span> time_points <span class="sc">-</span> <span class="dv">1</span>) {</span>
<span id="cb336-73"><a href="g-computation-for-causal-inference.html#cb336-73" tabindex="-1"></a>        <span class="co"># Treatment decision (based on previous blood pressure and risk factors)</span></span>
<span id="cb336-74"><a href="g-computation-for-causal-inference.html#cb336-74" tabindex="-1"></a>        treatment_prob <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> sbp <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> baseline<span class="sc">$</span>diabetes[i] <span class="sc">+</span> </span>
<span id="cb336-75"><a href="g-computation-for-causal-inference.html#cb336-75" tabindex="-1"></a>                                   <span class="fl">0.3</span> <span class="sc">*</span> baseline<span class="sc">$</span>smoking[i])</span>
<span id="cb336-76"><a href="g-computation-for-causal-inference.html#cb336-76" tabindex="-1"></a>        treatment <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, treatment_prob)</span>
<span id="cb336-77"><a href="g-computation-for-causal-inference.html#cb336-77" tabindex="-1"></a>        </span>
<span id="cb336-78"><a href="g-computation-for-causal-inference.html#cb336-78" tabindex="-1"></a>        <span class="co"># Adherence (affected by treatment intensity)</span></span>
<span id="cb336-79"><a href="g-computation-for-causal-inference.html#cb336-79" tabindex="-1"></a>        adherence_mean <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> treatment <span class="sc">+</span> <span class="fl">0.01</span> <span class="sc">*</span> (sbp <span class="sc">-</span> <span class="dv">120</span>))</span>
<span id="cb336-80"><a href="g-computation-for-causal-inference.html#cb336-80" tabindex="-1"></a>        <span class="co"># Transform to avoid boundary issues in beta regression</span></span>
<span id="cb336-81"><a href="g-computation-for-causal-inference.html#cb336-81" tabindex="-1"></a>        adherence <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fl">0.99</span>, <span class="fu">pmax</span>(<span class="fl">0.01</span>, <span class="fu">rnorm</span>(<span class="dv">1</span>, adherence_mean, <span class="fl">0.15</span>)))</span>
<span id="cb336-82"><a href="g-computation-for-causal-inference.html#cb336-82" tabindex="-1"></a>        </span>
<span id="cb336-83"><a href="g-computation-for-causal-inference.html#cb336-83" tabindex="-1"></a>        <span class="co"># Update SBP (affected by treatment and adherence)</span></span>
<span id="cb336-84"><a href="g-computation-for-causal-inference.html#cb336-84" tabindex="-1"></a>        treatment_effect <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">12</span> <span class="sc">*</span> treatment <span class="sc">*</span> adherence</span>
<span id="cb336-85"><a href="g-computation-for-causal-inference.html#cb336-85" tabindex="-1"></a>        sbp <span class="ot">&lt;-</span> <span class="fl">0.7</span> <span class="sc">*</span> sbp <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> baseline<span class="sc">$</span>baseline_sbp[i] <span class="sc">+</span> </span>
<span id="cb336-86"><a href="g-computation-for-causal-inference.html#cb336-86" tabindex="-1"></a>          treatment_effect <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb336-87"><a href="g-computation-for-causal-inference.html#cb336-87" tabindex="-1"></a>        sbp <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">90</span>, <span class="fu">pmin</span>(<span class="dv">200</span>, sbp))</span>
<span id="cb336-88"><a href="g-computation-for-causal-inference.html#cb336-88" tabindex="-1"></a>      }</span>
<span id="cb336-89"><a href="g-computation-for-causal-inference.html#cb336-89" tabindex="-1"></a>    }</span>
<span id="cb336-90"><a href="g-computation-for-causal-inference.html#cb336-90" tabindex="-1"></a>    </span>
<span id="cb336-91"><a href="g-computation-for-causal-inference.html#cb336-91" tabindex="-1"></a>    long_data[[i]] <span class="ot">&lt;-</span> individual_data</span>
<span id="cb336-92"><a href="g-computation-for-causal-inference.html#cb336-92" tabindex="-1"></a>  }</span>
<span id="cb336-93"><a href="g-computation-for-causal-inference.html#cb336-93" tabindex="-1"></a>  </span>
<span id="cb336-94"><a href="g-computation-for-causal-inference.html#cb336-94" tabindex="-1"></a>  <span class="co"># Combine all individual data</span></span>
<span id="cb336-95"><a href="g-computation-for-causal-inference.html#cb336-95" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(long_data)</span>
<span id="cb336-96"><a href="g-computation-for-causal-inference.html#cb336-96" tabindex="-1"></a>  <span class="fu">setorder</span>(data, id, time)</span>
<span id="cb336-97"><a href="g-computation-for-causal-inference.html#cb336-97" tabindex="-1"></a>  </span>
<span id="cb336-98"><a href="g-computation-for-causal-inference.html#cb336-98" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.data.frame</span>(data))</span>
<span id="cb336-99"><a href="g-computation-for-causal-inference.html#cb336-99" tabindex="-1"></a>}</span>
<span id="cb336-100"><a href="g-computation-for-causal-inference.html#cb336-100" tabindex="-1"></a></span>
<span id="cb336-101"><a href="g-computation-for-causal-inference.html#cb336-101" tabindex="-1"></a><span class="co"># Generate the dataset</span></span>
<span id="cb336-102"><a href="g-computation-for-causal-inference.html#cb336-102" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Simulating longitudinal hypertension data...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Simulating longitudinal hypertension data...</code></pre>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="g-computation-for-causal-inference.html#cb338-1" tabindex="-1"></a>hypertension_data <span class="ot">&lt;-</span> <span class="fu">simulate_hypertension_data</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">time_points =</span> <span class="dv">6</span>)</span>
<span id="cb338-2"><a href="g-computation-for-causal-inference.html#cb338-2" tabindex="-1"></a></span>
<span id="cb338-3"><a href="g-computation-for-causal-inference.html#cb338-3" tabindex="-1"></a><span class="co"># Create lagged variables</span></span>
<span id="cb338-4"><a href="g-computation-for-causal-inference.html#cb338-4" tabindex="-1"></a>hypertension_data <span class="ot">&lt;-</span> hypertension_data <span class="sc">%&gt;%</span></span>
<span id="cb338-5"><a href="g-computation-for-causal-inference.html#cb338-5" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb338-6"><a href="g-computation-for-causal-inference.html#cb338-6" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb338-7"><a href="g-computation-for-causal-inference.html#cb338-7" tabindex="-1"></a>    <span class="at">sbp_lag =</span> <span class="fu">lag</span>(sbp, <span class="at">default =</span> <span class="fu">first</span>(sbp)),</span>
<span id="cb338-8"><a href="g-computation-for-causal-inference.html#cb338-8" tabindex="-1"></a>    <span class="at">treatment_lag =</span> <span class="fu">lag</span>(treatment, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb338-9"><a href="g-computation-for-causal-inference.html#cb338-9" tabindex="-1"></a>    <span class="at">adherence_lag =</span> <span class="fu">lag</span>(adherence, <span class="at">default =</span> <span class="dv">1</span>)</span>
<span id="cb338-10"><a href="g-computation-for-causal-inference.html#cb338-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb338-11"><a href="g-computation-for-causal-inference.html#cb338-11" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb338-12"><a href="g-computation-for-causal-inference.html#cb338-12" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb338-13"><a href="g-computation-for-causal-inference.html#cb338-13" tabindex="-1"></a></span>
<span id="cb338-14"><a href="g-computation-for-causal-inference.html#cb338-14" tabindex="-1"></a><span class="co"># Display summary statistics</span></span>
<span id="cb338-15"><a href="g-computation-for-causal-inference.html#cb338-15" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Dataset Summary:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Dataset Summary:</code></pre>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb340-1"><a href="g-computation-for-causal-inference.html#cb340-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Total observations:&quot;</span>, <span class="fu">nrow</span>(hypertension_data), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Total observations: 6000</code></pre>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb342-1"><a href="g-computation-for-causal-inference.html#cb342-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Number of patients:&quot;</span>, <span class="fu">length</span>(<span class="fu">unique</span>(hypertension_data<span class="sc">$</span>id)), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Number of patients: 1000</code></pre>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb344-1"><a href="g-computation-for-causal-inference.html#cb344-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Time points:&quot;</span>, <span class="fu">max</span>(hypertension_data<span class="sc">$</span>time) <span class="sc">+</span> <span class="dv">1</span>, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Time points: 6</code></pre>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="g-computation-for-causal-inference.html#cb346-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Baseline characteristics:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Baseline characteristics:</code></pre>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="g-computation-for-causal-inference.html#cb348-1" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(hypertension_data[hypertension_data<span class="sc">$</span>time <span class="sc">==</span> <span class="dv">0</span>, </span>
<span id="cb348-2"><a href="g-computation-for-causal-inference.html#cb348-2" tabindex="-1"></a>                                <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;diabetes&quot;</span>, <span class="st">&quot;smoking&quot;</span>, <span class="st">&quot;sbp&quot;</span>)]))</span></code></pre></div>
<pre><code>##       age           diabetes        smoking           sbp       
##  Min.   :32.52   Min.   :0.000   Min.   :0.000   Min.   :102.3  
##  1st Qu.:49.97   1st Qu.:0.000   1st Qu.:0.000   1st Qu.:135.2  
##  Median :55.07   Median :0.000   Median :0.000   Median :144.2  
##  Mean   :55.13   Mean   :0.307   Mean   :0.263   Mean   :144.7  
##  3rd Qu.:60.32   3rd Qu.:1.000   3rd Qu.:1.000   3rd Qu.:154.6  
##  Max.   :80.93   Max.   :1.000   Max.   :1.000   Max.   :196.3</code></pre>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb350-1"><a href="g-computation-for-causal-inference.html#cb350-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Incident CVD events by time point:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Incident CVD events by time point:</code></pre>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb352-1"><a href="g-computation-for-causal-inference.html#cb352-1" tabindex="-1"></a>event_rates <span class="ot">&lt;-</span> hypertension_data <span class="sc">%&gt;%</span></span>
<span id="cb352-2"><a href="g-computation-for-causal-inference.html#cb352-2" tabindex="-1"></a>  <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb352-3"><a href="g-computation-for-causal-inference.html#cb352-3" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb352-4"><a href="g-computation-for-causal-inference.html#cb352-4" tabindex="-1"></a>    <span class="at">incident_events =</span> <span class="fu">sum</span>(cvd_event),</span>
<span id="cb352-5"><a href="g-computation-for-causal-inference.html#cb352-5" tabindex="-1"></a>    <span class="at">cumulative_incidence =</span> <span class="fu">mean</span>(<span class="sc">!</span><span class="fu">is.na</span>(event_time) <span class="sc">&amp;</span> event_time <span class="sc">&lt;=</span> time)</span>
<span id="cb352-6"><a href="g-computation-for-causal-inference.html#cb352-6" tabindex="-1"></a>  )</span>
<span id="cb352-7"><a href="g-computation-for-causal-inference.html#cb352-7" tabindex="-1"></a><span class="fu">print</span>(event_rates)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##    time incident_events cumulative_incidence
##   &lt;int&gt;           &lt;dbl&gt;                &lt;dbl&gt;
## 1     0             697                0.697
## 2     1             154                0.851
## 3     2              53                0.904
## 4     3              33                0.937
## 5     4              23                0.96 
## 6     5              16                0.976</code></pre>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb354-1"><a href="g-computation-for-causal-inference.html#cb354-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">=== MODEL FITTING ===</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## 
## === MODEL FITTING ===</code></pre>
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb356-1"><a href="g-computation-for-causal-inference.html#cb356-1" tabindex="-1"></a>fit_confounder_models <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb356-2"><a href="g-computation-for-causal-inference.html#cb356-2" tabindex="-1"></a>  <span class="co"># SBP model (continuous outcome)</span></span>
<span id="cb356-3"><a href="g-computation-for-causal-inference.html#cb356-3" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Fitting SBP model...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb356-4"><a href="g-computation-for-causal-inference.html#cb356-4" tabindex="-1"></a>  sbp_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(sbp <span class="sc">~</span> sbp_lag <span class="sc">+</span> treatment <span class="sc">+</span> treatment_lag <span class="sc">+</span> </span>
<span id="cb356-5"><a href="g-computation-for-causal-inference.html#cb356-5" tabindex="-1"></a>                    adherence <span class="sc">+</span> adherence_lag <span class="sc">+</span> diabetes <span class="sc">+</span> smoking <span class="sc">+</span> age <span class="sc">+</span> time,</span>
<span id="cb356-6"><a href="g-computation-for-causal-inference.html#cb356-6" tabindex="-1"></a>                  <span class="at">data =</span> data[data<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">0</span>, ])</span>
<span id="cb356-7"><a href="g-computation-for-causal-inference.html#cb356-7" tabindex="-1"></a>  </span>
<span id="cb356-8"><a href="g-computation-for-causal-inference.html#cb356-8" tabindex="-1"></a>  <span class="co"># Adherence model (beta regression for bounded continuous outcome)</span></span>
<span id="cb356-9"><a href="g-computation-for-causal-inference.html#cb356-9" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Fitting adherence model...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb356-10"><a href="g-computation-for-causal-inference.html#cb356-10" tabindex="-1"></a>  <span class="co"># Beta regression requires values in (0,1), not including boundaries</span></span>
<span id="cb356-11"><a href="g-computation-for-causal-inference.html#cb356-11" tabindex="-1"></a>  adherence_data <span class="ot">&lt;-</span> data[data<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> data<span class="sc">$</span>adherence <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> data<span class="sc">$</span>adherence <span class="sc">&lt;</span> <span class="dv">1</span>, ]</span>
<span id="cb356-12"><a href="g-computation-for-causal-inference.html#cb356-12" tabindex="-1"></a>  adherence_model <span class="ot">&lt;-</span> <span class="fu">betareg</span>(adherence <span class="sc">~</span> treatment <span class="sc">+</span> sbp_lag <span class="sc">+</span> diabetes <span class="sc">+</span> time,</span>
<span id="cb356-13"><a href="g-computation-for-causal-inference.html#cb356-13" tabindex="-1"></a>                             <span class="at">data =</span> adherence_data)</span>
<span id="cb356-14"><a href="g-computation-for-causal-inference.html#cb356-14" tabindex="-1"></a>  </span>
<span id="cb356-15"><a href="g-computation-for-causal-inference.html#cb356-15" tabindex="-1"></a>  <span class="co"># Outcome model (logistic regression for incident events)</span></span>
<span id="cb356-16"><a href="g-computation-for-causal-inference.html#cb356-16" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Fitting CVD outcome model...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb356-17"><a href="g-computation-for-causal-inference.html#cb356-17" tabindex="-1"></a>  <span class="co"># Only model incident events (not absorbing state)</span></span>
<span id="cb356-18"><a href="g-computation-for-causal-inference.html#cb356-18" tabindex="-1"></a>  outcome_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(cvd_event <span class="sc">~</span> sbp <span class="sc">+</span> treatment <span class="sc">+</span> adherence <span class="sc">+</span> </span>
<span id="cb356-19"><a href="g-computation-for-causal-inference.html#cb356-19" tabindex="-1"></a>                         age <span class="sc">+</span> diabetes <span class="sc">+</span> smoking <span class="sc">+</span> time,</span>
<span id="cb356-20"><a href="g-computation-for-causal-inference.html#cb356-20" tabindex="-1"></a>                       <span class="at">data =</span> data, </span>
<span id="cb356-21"><a href="g-computation-for-causal-inference.html#cb356-21" tabindex="-1"></a>                       <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb356-22"><a href="g-computation-for-causal-inference.html#cb356-22" tabindex="-1"></a>  </span>
<span id="cb356-23"><a href="g-computation-for-causal-inference.html#cb356-23" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Model diagnostics:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb356-24"><a href="g-computation-for-causal-inference.html#cb356-24" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;SBP model R-squared:&quot;</span>, <span class="fu">round</span>(<span class="fu">summary</span>(sbp_model)<span class="sc">$</span>r.squared, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb356-25"><a href="g-computation-for-causal-inference.html#cb356-25" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Adherence model pseudo R-squared:&quot;</span>, <span class="fu">round</span>(adherence_model<span class="sc">$</span>pseudo.r.squared, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb356-26"><a href="g-computation-for-causal-inference.html#cb356-26" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Outcome model AIC:&quot;</span>, <span class="fu">round</span>(<span class="fu">AIC</span>(outcome_model), <span class="dv">1</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb356-27"><a href="g-computation-for-causal-inference.html#cb356-27" tabindex="-1"></a>  </span>
<span id="cb356-28"><a href="g-computation-for-causal-inference.html#cb356-28" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb356-29"><a href="g-computation-for-causal-inference.html#cb356-29" tabindex="-1"></a>    <span class="at">sbp =</span> sbp_model, </span>
<span id="cb356-30"><a href="g-computation-for-causal-inference.html#cb356-30" tabindex="-1"></a>    <span class="at">adherence =</span> adherence_model, </span>
<span id="cb356-31"><a href="g-computation-for-causal-inference.html#cb356-31" tabindex="-1"></a>    <span class="at">outcome =</span> outcome_model,</span>
<span id="cb356-32"><a href="g-computation-for-causal-inference.html#cb356-32" tabindex="-1"></a>    <span class="at">sbp_sigma =</span> <span class="fu">sigma</span>(sbp_model)</span>
<span id="cb356-33"><a href="g-computation-for-causal-inference.html#cb356-33" tabindex="-1"></a>  )</span>
<span id="cb356-34"><a href="g-computation-for-causal-inference.html#cb356-34" tabindex="-1"></a>}</span>
<span id="cb356-35"><a href="g-computation-for-causal-inference.html#cb356-35" tabindex="-1"></a></span>
<span id="cb356-36"><a href="g-computation-for-causal-inference.html#cb356-36" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">fit_confounder_models</span>(hypertension_data)</span></code></pre></div>
<pre><code>## Fitting SBP model...
## Fitting adherence model...
## Fitting CVD outcome model...
## 
## Model diagnostics:
## SBP model R-squared: 0.885 
## Adherence model pseudo R-squared: 0.078 
## Outcome model AIC: 3239.2</code></pre>
<div class="sourceCode" id="cb358"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb358-1"><a href="g-computation-for-causal-inference.html#cb358-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">SBP Model - Treatment Effect:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## SBP Model - Treatment Effect:</code></pre>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="g-computation-for-causal-inference.html#cb360-1" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">coef</span>(<span class="fu">summary</span>(models<span class="sc">$</span>sbp))[<span class="st">&quot;treatment&quot;</span>, ])</span></code></pre></div>
<pre><code>##       Estimate     Std. Error        t value       Pr(&gt;|t|) 
##  -8.665117e+00   2.525781e-01  -3.430668e+01  8.862651e-232</code></pre>
<div class="sourceCode" id="cb362"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb362-1"><a href="g-computation-for-causal-inference.html#cb362-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Outcome Model - Treatment Effect:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Outcome Model - Treatment Effect:</code></pre>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb364-1"><a href="g-computation-for-causal-inference.html#cb364-1" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">coef</span>(<span class="fu">summary</span>(models<span class="sc">$</span>outcome))[<span class="st">&quot;treatment&quot;</span>, ])</span></code></pre></div>
<pre><code>##      Estimate    Std. Error       z value      Pr(&gt;|z|) 
## -1.338476e+00  1.351212e-01 -9.905741e+00  3.930469e-23</code></pre>
<div id="fitting-the-g-formula-model" class="section level3 hasAnchor" number="11.2.1">
<h3><span class="header-section-number">11.2.1</span> Fitting the G-Formula Model<a href="g-computation-for-causal-inference.html#fitting-the-g-formula-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>gfoRmula</code> package provides a comprehensive implementation of the parametric G-formula algorithm with built-in bootstrap inference and diagnostic tools. The key challenge lies in correctly specifying the models for time-varying confounders and the outcome, capturing the dependence structure while avoiding overfitting.</p>
<p>The model specification requires careful consideration of which variables predict confounder evolution and outcomes. For systolic blood pressure, we include the lagged value to capture persistence, current treatment and adherence to capture treatment effects, and baseline risk factors that might influence blood pressure trajectory. The adherence model captures how treatment intensity and perceived risk (via lagged blood pressure) influence compliance. The outcome model includes both current blood pressure and treatment, allowing the effect of treatment to operate both through blood pressure reduction and potentially through other pathways.</p>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb366-1"><a href="g-computation-for-causal-inference.html#cb366-1" tabindex="-1"></a>simulate_counterfactual_mc <span class="ot">&lt;-</span> <span class="cf">function</span>(data, models, treatment_strategy, </span>
<span id="cb366-2"><a href="g-computation-for-causal-inference.html#cb366-2" tabindex="-1"></a>                                       <span class="at">n_simulations =</span> <span class="dv">500</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb366-3"><a href="g-computation-for-causal-inference.html#cb366-3" tabindex="-1"></a>  </span>
<span id="cb366-4"><a href="g-computation-for-causal-inference.html#cb366-4" tabindex="-1"></a>  baseline_data <span class="ot">&lt;-</span> data[data<span class="sc">$</span>time <span class="sc">==</span> <span class="dv">0</span>, ]</span>
<span id="cb366-5"><a href="g-computation-for-causal-inference.html#cb366-5" tabindex="-1"></a>  n_subjects <span class="ot">&lt;-</span> <span class="fu">nrow</span>(baseline_data)</span>
<span id="cb366-6"><a href="g-computation-for-causal-inference.html#cb366-6" tabindex="-1"></a>  </span>
<span id="cb366-7"><a href="g-computation-for-causal-inference.html#cb366-7" tabindex="-1"></a>  <span class="co"># Store results across simulations</span></span>
<span id="cb366-8"><a href="g-computation-for-causal-inference.html#cb366-8" tabindex="-1"></a>  all_risks <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n_simulations, <span class="at">ncol =</span> <span class="dv">6</span>)</span>
<span id="cb366-9"><a href="g-computation-for-causal-inference.html#cb366-9" tabindex="-1"></a>  all_cumulative_incidence <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_simulations)</span>
<span id="cb366-10"><a href="g-computation-for-causal-inference.html#cb366-10" tabindex="-1"></a>  </span>
<span id="cb366-11"><a href="g-computation-for-causal-inference.html#cb366-11" tabindex="-1"></a>  <span class="cf">for</span> (sim <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_simulations) {</span>
<span id="cb366-12"><a href="g-computation-for-causal-inference.html#cb366-12" tabindex="-1"></a>    <span class="cf">if</span> (verbose <span class="sc">&amp;&amp;</span> sim <span class="sc">%%</span> <span class="dv">100</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">cat</span>(<span class="st">&quot;  Simulation&quot;</span>, sim, <span class="st">&quot;of&quot;</span>, n_simulations, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb366-13"><a href="g-computation-for-causal-inference.html#cb366-13" tabindex="-1"></a>    </span>
<span id="cb366-14"><a href="g-computation-for-causal-inference.html#cb366-14" tabindex="-1"></a>    sim_data <span class="ot">&lt;-</span> baseline_data</span>
<span id="cb366-15"><a href="g-computation-for-causal-inference.html#cb366-15" tabindex="-1"></a>    sim_data<span class="sc">$</span>treatment <span class="ot">&lt;-</span> <span class="fu">treatment_strategy</span>(sim_data, <span class="dv">0</span>)</span>
<span id="cb366-16"><a href="g-computation-for-causal-inference.html#cb366-16" tabindex="-1"></a>    sim_data<span class="sc">$</span>cvd_event_sim <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb366-17"><a href="g-computation-for-causal-inference.html#cb366-17" tabindex="-1"></a>    sim_data<span class="sc">$</span>event_occurred <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb366-18"><a href="g-computation-for-causal-inference.html#cb366-18" tabindex="-1"></a>    </span>
<span id="cb366-19"><a href="g-computation-for-causal-inference.html#cb366-19" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb366-20"><a href="g-computation-for-causal-inference.html#cb366-20" tabindex="-1"></a>      prev_data <span class="ot">&lt;-</span> sim_data[sim_data<span class="sc">$</span>time <span class="sc">==</span> t <span class="sc">-</span> <span class="dv">1</span>, ]</span>
<span id="cb366-21"><a href="g-computation-for-causal-inference.html#cb366-21" tabindex="-1"></a>      </span>
<span id="cb366-22"><a href="g-computation-for-causal-inference.html#cb366-22" tabindex="-1"></a>      <span class="co"># Create new data for time t</span></span>
<span id="cb366-23"><a href="g-computation-for-causal-inference.html#cb366-23" tabindex="-1"></a>      new_data <span class="ot">&lt;-</span> prev_data</span>
<span id="cb366-24"><a href="g-computation-for-causal-inference.html#cb366-24" tabindex="-1"></a>      new_data<span class="sc">$</span>time <span class="ot">&lt;-</span> t</span>
<span id="cb366-25"><a href="g-computation-for-causal-inference.html#cb366-25" tabindex="-1"></a>      new_data<span class="sc">$</span>treatment_lag <span class="ot">&lt;-</span> prev_data<span class="sc">$</span>treatment</span>
<span id="cb366-26"><a href="g-computation-for-causal-inference.html#cb366-26" tabindex="-1"></a>      new_data<span class="sc">$</span>sbp_lag <span class="ot">&lt;-</span> prev_data<span class="sc">$</span>sbp</span>
<span id="cb366-27"><a href="g-computation-for-causal-inference.html#cb366-27" tabindex="-1"></a>      new_data<span class="sc">$</span>adherence_lag <span class="ot">&lt;-</span> prev_data<span class="sc">$</span>adherence</span>
<span id="cb366-28"><a href="g-computation-for-causal-inference.html#cb366-28" tabindex="-1"></a>      </span>
<span id="cb366-29"><a href="g-computation-for-causal-inference.html#cb366-29" tabindex="-1"></a>      <span class="co"># Assign treatment according to strategy</span></span>
<span id="cb366-30"><a href="g-computation-for-causal-inference.html#cb366-30" tabindex="-1"></a>      new_data<span class="sc">$</span>treatment <span class="ot">&lt;-</span> <span class="fu">treatment_strategy</span>(new_data, t)</span>
<span id="cb366-31"><a href="g-computation-for-causal-inference.html#cb366-31" tabindex="-1"></a>      </span>
<span id="cb366-32"><a href="g-computation-for-causal-inference.html#cb366-32" tabindex="-1"></a>      <span class="co"># Simulate adherence</span></span>
<span id="cb366-33"><a href="g-computation-for-causal-inference.html#cb366-33" tabindex="-1"></a>      adherence_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(models<span class="sc">$</span>adherence, <span class="at">newdata =</span> new_data, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb366-34"><a href="g-computation-for-causal-inference.html#cb366-34" tabindex="-1"></a>      adherence_noise <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(new_data), <span class="dv">0</span>, <span class="fl">0.1</span>)</span>
<span id="cb366-35"><a href="g-computation-for-causal-inference.html#cb366-35" tabindex="-1"></a>      new_data<span class="sc">$</span>adherence <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fl">0.99</span>, <span class="fu">pmax</span>(<span class="fl">0.01</span>, adherence_pred <span class="sc">+</span> adherence_noise))</span>
<span id="cb366-36"><a href="g-computation-for-causal-inference.html#cb366-36" tabindex="-1"></a>      </span>
<span id="cb366-37"><a href="g-computation-for-causal-inference.html#cb366-37" tabindex="-1"></a>      <span class="co"># Simulate SBP</span></span>
<span id="cb366-38"><a href="g-computation-for-causal-inference.html#cb366-38" tabindex="-1"></a>      sbp_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(models<span class="sc">$</span>sbp, <span class="at">newdata =</span> new_data)</span>
<span id="cb366-39"><a href="g-computation-for-causal-inference.html#cb366-39" tabindex="-1"></a>      new_data<span class="sc">$</span>sbp <span class="ot">&lt;-</span> sbp_pred <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(new_data), <span class="dv">0</span>, models<span class="sc">$</span>sbp_sigma)</span>
<span id="cb366-40"><a href="g-computation-for-causal-inference.html#cb366-40" tabindex="-1"></a>      new_data<span class="sc">$</span>sbp <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="dv">200</span>, <span class="fu">pmax</span>(<span class="dv">90</span>, new_data<span class="sc">$</span>sbp))</span>
<span id="cb366-41"><a href="g-computation-for-causal-inference.html#cb366-41" tabindex="-1"></a>      </span>
<span id="cb366-42"><a href="g-computation-for-causal-inference.html#cb366-42" tabindex="-1"></a>      <span class="co"># Simulate CVD events (only for those who haven&#39;t had event yet)</span></span>
<span id="cb366-43"><a href="g-computation-for-causal-inference.html#cb366-43" tabindex="-1"></a>      cvd_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(models<span class="sc">$</span>outcome, <span class="at">newdata =</span> new_data, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb366-44"><a href="g-computation-for-causal-inference.html#cb366-44" tabindex="-1"></a>      new_event <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="fu">nrow</span>(new_data), <span class="dv">1</span>, cvd_prob)</span>
<span id="cb366-45"><a href="g-computation-for-causal-inference.html#cb366-45" tabindex="-1"></a>      </span>
<span id="cb366-46"><a href="g-computation-for-causal-inference.html#cb366-46" tabindex="-1"></a>      <span class="co"># Only count incident events</span></span>
<span id="cb366-47"><a href="g-computation-for-causal-inference.html#cb366-47" tabindex="-1"></a>      new_data<span class="sc">$</span>cvd_event_sim <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="sc">!</span>prev_data<span class="sc">$</span>event_occurred, new_event, <span class="dv">0</span>)</span>
<span id="cb366-48"><a href="g-computation-for-causal-inference.html#cb366-48" tabindex="-1"></a>      new_data<span class="sc">$</span>event_occurred <span class="ot">&lt;-</span> prev_data<span class="sc">$</span>event_occurred <span class="sc">|</span> (new_event <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb366-49"><a href="g-computation-for-causal-inference.html#cb366-49" tabindex="-1"></a>      </span>
<span id="cb366-50"><a href="g-computation-for-causal-inference.html#cb366-50" tabindex="-1"></a>      sim_data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(sim_data, new_data)</span>
<span id="cb366-51"><a href="g-computation-for-causal-inference.html#cb366-51" tabindex="-1"></a>    }</span>
<span id="cb366-52"><a href="g-computation-for-causal-inference.html#cb366-52" tabindex="-1"></a>    </span>
<span id="cb366-53"><a href="g-computation-for-causal-inference.html#cb366-53" tabindex="-1"></a>    <span class="co"># Calculate risk at each time point for this simulation</span></span>
<span id="cb366-54"><a href="g-computation-for-causal-inference.html#cb366-54" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb366-55"><a href="g-computation-for-causal-inference.html#cb366-55" tabindex="-1"></a>      all_risks[sim, t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(sim_data[sim_data<span class="sc">$</span>time <span class="sc">==</span> t, <span class="st">&quot;event_occurred&quot;</span>])</span>
<span id="cb366-56"><a href="g-computation-for-causal-inference.html#cb366-56" tabindex="-1"></a>    }</span>
<span id="cb366-57"><a href="g-computation-for-causal-inference.html#cb366-57" tabindex="-1"></a>    </span>
<span id="cb366-58"><a href="g-computation-for-causal-inference.html#cb366-58" tabindex="-1"></a>    <span class="co"># Cumulative incidence by end of follow-up</span></span>
<span id="cb366-59"><a href="g-computation-for-causal-inference.html#cb366-59" tabindex="-1"></a>    all_cumulative_incidence[sim] <span class="ot">&lt;-</span> <span class="fu">mean</span>(sim_data[sim_data<span class="sc">$</span>time <span class="sc">==</span> <span class="dv">5</span>, <span class="st">&quot;event_occurred&quot;</span>])</span>
<span id="cb366-60"><a href="g-computation-for-causal-inference.html#cb366-60" tabindex="-1"></a>  }</span>
<span id="cb366-61"><a href="g-computation-for-causal-inference.html#cb366-61" tabindex="-1"></a>  </span>
<span id="cb366-62"><a href="g-computation-for-causal-inference.html#cb366-62" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb366-63"><a href="g-computation-for-causal-inference.html#cb366-63" tabindex="-1"></a>    <span class="at">mean_risk_trajectory =</span> <span class="fu">colMeans</span>(all_risks),</span>
<span id="cb366-64"><a href="g-computation-for-causal-inference.html#cb366-64" tabindex="-1"></a>    <span class="at">risk_trajectory_se =</span> <span class="fu">apply</span>(all_risks, <span class="dv">2</span>, sd),</span>
<span id="cb366-65"><a href="g-computation-for-causal-inference.html#cb366-65" tabindex="-1"></a>    <span class="at">cumulative_incidence =</span> <span class="fu">mean</span>(all_cumulative_incidence),</span>
<span id="cb366-66"><a href="g-computation-for-causal-inference.html#cb366-66" tabindex="-1"></a>    <span class="at">cumulative_incidence_se =</span> <span class="fu">sd</span>(all_cumulative_incidence),</span>
<span id="cb366-67"><a href="g-computation-for-causal-inference.html#cb366-67" tabindex="-1"></a>    <span class="at">all_cumulative_incidence =</span> all_cumulative_incidence</span>
<span id="cb366-68"><a href="g-computation-for-causal-inference.html#cb366-68" tabindex="-1"></a>  )</span>
<span id="cb366-69"><a href="g-computation-for-causal-inference.html#cb366-69" tabindex="-1"></a>}</span>
<span id="cb366-70"><a href="g-computation-for-causal-inference.html#cb366-70" tabindex="-1"></a></span>
<span id="cb366-71"><a href="g-computation-for-causal-inference.html#cb366-71" tabindex="-1"></a><span class="co"># Define treatment strategies</span></span>
<span id="cb366-72"><a href="g-computation-for-causal-inference.html#cb366-72" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb366-73"><a href="g-computation-for-causal-inference.html#cb366-73" tabindex="-1"></a>  <span class="at">never_treat =</span> <span class="cf">function</span>(data, time) <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data)),</span>
<span id="cb366-74"><a href="g-computation-for-causal-inference.html#cb366-74" tabindex="-1"></a>  <span class="at">always_treat =</span> <span class="cf">function</span>(data, time) <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(data)),</span>
<span id="cb366-75"><a href="g-computation-for-causal-inference.html#cb366-75" tabindex="-1"></a>  <span class="at">delayed_treat =</span> <span class="cf">function</span>(data, time) <span class="fu">ifelse</span>(time <span class="sc">&gt;=</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb366-76"><a href="g-computation-for-causal-inference.html#cb366-76" tabindex="-1"></a>  <span class="at">threshold_strategy =</span> <span class="cf">function</span>(data, time) {</span>
<span id="cb366-77"><a href="g-computation-for-causal-inference.html#cb366-77" tabindex="-1"></a>    <span class="cf">if</span> (time <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data)))</span>
<span id="cb366-78"><a href="g-computation-for-causal-inference.html#cb366-78" tabindex="-1"></a>    <span class="fu">ifelse</span>(data<span class="sc">$</span>sbp <span class="sc">&gt;</span> <span class="dv">140</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb366-79"><a href="g-computation-for-causal-inference.html#cb366-79" tabindex="-1"></a>  }</span>
<span id="cb366-80"><a href="g-computation-for-causal-inference.html#cb366-80" tabindex="-1"></a>)</span>
<span id="cb366-81"><a href="g-computation-for-causal-inference.html#cb366-81" tabindex="-1"></a></span>
<span id="cb366-82"><a href="g-computation-for-causal-inference.html#cb366-82" tabindex="-1"></a><span class="co"># Run simulations for each strategy</span></span>
<span id="cb366-83"><a href="g-computation-for-causal-inference.html#cb366-83" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Running Monte Carlo simulations (500 iterations per strategy)...</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Running Monte Carlo simulations (500 iterations per strategy)...</code></pre>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb368-1"><a href="g-computation-for-causal-inference.html#cb368-1" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb368-2"><a href="g-computation-for-causal-inference.html#cb368-2" tabindex="-1"></a></span>
<span id="cb368-3"><a href="g-computation-for-causal-inference.html#cb368-3" tabindex="-1"></a><span class="cf">for</span> (strategy_name <span class="cf">in</span> <span class="fu">names</span>(strategies)) {</span>
<span id="cb368-4"><a href="g-computation-for-causal-inference.html#cb368-4" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Strategy:&quot;</span>, strategy_name, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb368-5"><a href="g-computation-for-causal-inference.html#cb368-5" tabindex="-1"></a>  results[[strategy_name]] <span class="ot">&lt;-</span> <span class="fu">simulate_counterfactual_mc</span>(</span>
<span id="cb368-6"><a href="g-computation-for-causal-inference.html#cb368-6" tabindex="-1"></a>    hypertension_data, </span>
<span id="cb368-7"><a href="g-computation-for-causal-inference.html#cb368-7" tabindex="-1"></a>    models, </span>
<span id="cb368-8"><a href="g-computation-for-causal-inference.html#cb368-8" tabindex="-1"></a>    strategies[[strategy_name]],</span>
<span id="cb368-9"><a href="g-computation-for-causal-inference.html#cb368-9" tabindex="-1"></a>    <span class="at">n_simulations =</span> <span class="dv">500</span>,</span>
<span id="cb368-10"><a href="g-computation-for-causal-inference.html#cb368-10" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb368-11"><a href="g-computation-for-causal-inference.html#cb368-11" tabindex="-1"></a>  )</span>
<span id="cb368-12"><a href="g-computation-for-causal-inference.html#cb368-12" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;  Cumulative incidence at 5 years:&quot;</span>, </span>
<span id="cb368-13"><a href="g-computation-for-causal-inference.html#cb368-13" tabindex="-1"></a>      <span class="fu">round</span>(results[[strategy_name]]<span class="sc">$</span>cumulative_incidence <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="st">&quot;%&quot;</span>,</span>
<span id="cb368-14"><a href="g-computation-for-causal-inference.html#cb368-14" tabindex="-1"></a>      <span class="st">&quot; (SE:&quot;</span>, <span class="fu">round</span>(results[[strategy_name]]<span class="sc">$</span>cumulative_incidence_se <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="st">&quot;%)</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span>
<span id="cb368-15"><a href="g-computation-for-causal-inference.html#cb368-15" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Strategy: never_treat 
##   Cumulative incidence at 5 years: 63.48 %  (SE: 1.65 %)
## 
## Strategy: always_treat 
##   Cumulative incidence at 5 years: 24.65 %  (SE: 1.41 %)
## 
## Strategy: delayed_treat 
##   Cumulative incidence at 5 years: 49.19 %  (SE: 1.55 %)
## 
## Strategy: threshold_strategy 
##   Cumulative incidence at 5 years: 43.62 %  (SE: 1.55 %)</code></pre>
<div class="sourceCode" id="cb370"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb370-1"><a href="g-computation-for-causal-inference.html#cb370-1" tabindex="-1"></a><span class="co"># Function to calculate risk difference and ratio with bootstrap CI</span></span>
<span id="cb370-2"><a href="g-computation-for-causal-inference.html#cb370-2" tabindex="-1"></a>calculate_effect <span class="ot">&lt;-</span> <span class="cf">function</span>(results, reference, comparator) {</span>
<span id="cb370-3"><a href="g-computation-for-causal-inference.html#cb370-3" tabindex="-1"></a>  ref_samples <span class="ot">&lt;-</span> results[[reference]]<span class="sc">$</span>all_cumulative_incidence</span>
<span id="cb370-4"><a href="g-computation-for-causal-inference.html#cb370-4" tabindex="-1"></a>  comp_samples <span class="ot">&lt;-</span> results[[comparator]]<span class="sc">$</span>all_cumulative_incidence</span>
<span id="cb370-5"><a href="g-computation-for-causal-inference.html#cb370-5" tabindex="-1"></a>  </span>
<span id="cb370-6"><a href="g-computation-for-causal-inference.html#cb370-6" tabindex="-1"></a>  risk_diff <span class="ot">&lt;-</span> ref_samples <span class="sc">-</span> comp_samples</span>
<span id="cb370-7"><a href="g-computation-for-causal-inference.html#cb370-7" tabindex="-1"></a>  risk_ratio <span class="ot">&lt;-</span> ref_samples <span class="sc">/</span> comp_samples</span>
<span id="cb370-8"><a href="g-computation-for-causal-inference.html#cb370-8" tabindex="-1"></a>  </span>
<span id="cb370-9"><a href="g-computation-for-causal-inference.html#cb370-9" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb370-10"><a href="g-computation-for-causal-inference.html#cb370-10" tabindex="-1"></a>    <span class="at">risk_diff_mean =</span> <span class="fu">mean</span>(risk_diff),</span>
<span id="cb370-11"><a href="g-computation-for-causal-inference.html#cb370-11" tabindex="-1"></a>    <span class="at">risk_diff_ci =</span> <span class="fu">quantile</span>(risk_diff, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)),</span>
<span id="cb370-12"><a href="g-computation-for-causal-inference.html#cb370-12" tabindex="-1"></a>    <span class="at">risk_ratio_mean =</span> <span class="fu">mean</span>(risk_ratio),</span>
<span id="cb370-13"><a href="g-computation-for-causal-inference.html#cb370-13" tabindex="-1"></a>    <span class="at">risk_ratio_ci =</span> <span class="fu">quantile</span>(risk_ratio, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb370-14"><a href="g-computation-for-causal-inference.html#cb370-14" tabindex="-1"></a>  )</span>
<span id="cb370-15"><a href="g-computation-for-causal-inference.html#cb370-15" tabindex="-1"></a>}</span>
<span id="cb370-16"><a href="g-computation-for-causal-inference.html#cb370-16" tabindex="-1"></a></span>
<span id="cb370-17"><a href="g-computation-for-causal-inference.html#cb370-17" tabindex="-1"></a><span class="co"># Compare strategies</span></span>
<span id="cb370-18"><a href="g-computation-for-causal-inference.html#cb370-18" tabindex="-1"></a>comparisons <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb370-19"><a href="g-computation-for-causal-inference.html#cb370-19" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">&quot;never_treat&quot;</span>, <span class="st">&quot;always_treat&quot;</span>),</span>
<span id="cb370-20"><a href="g-computation-for-causal-inference.html#cb370-20" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">&quot;never_treat&quot;</span>, <span class="st">&quot;threshold_strategy&quot;</span>),</span>
<span id="cb370-21"><a href="g-computation-for-causal-inference.html#cb370-21" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">&quot;always_treat&quot;</span>, <span class="st">&quot;threshold_strategy&quot;</span>)</span>
<span id="cb370-22"><a href="g-computation-for-causal-inference.html#cb370-22" tabindex="-1"></a>)</span>
<span id="cb370-23"><a href="g-computation-for-causal-inference.html#cb370-23" tabindex="-1"></a></span>
<span id="cb370-24"><a href="g-computation-for-causal-inference.html#cb370-24" tabindex="-1"></a>effect_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb370-25"><a href="g-computation-for-causal-inference.html#cb370-25" tabindex="-1"></a></span>
<span id="cb370-26"><a href="g-computation-for-causal-inference.html#cb370-26" tabindex="-1"></a><span class="cf">for</span> (comp <span class="cf">in</span> comparisons) {</span>
<span id="cb370-27"><a href="g-computation-for-causal-inference.html#cb370-27" tabindex="-1"></a>  effect <span class="ot">&lt;-</span> <span class="fu">calculate_effect</span>(results, comp[<span class="dv">1</span>], comp[<span class="dv">2</span>])</span>
<span id="cb370-28"><a href="g-computation-for-causal-inference.html#cb370-28" tabindex="-1"></a>  </span>
<span id="cb370-29"><a href="g-computation-for-causal-inference.html#cb370-29" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">%s vs %s:</span><span class="sc">\n</span><span class="st">&quot;</span>, comp[<span class="dv">1</span>], comp[<span class="dv">2</span>]))</span>
<span id="cb370-30"><a href="g-computation-for-causal-inference.html#cb370-30" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  Risk Difference: %.2f%% (95%% CI: %.2f%% to %.2f%%)</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb370-31"><a href="g-computation-for-causal-inference.html#cb370-31" tabindex="-1"></a>              effect<span class="sc">$</span>risk_diff_mean <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb370-32"><a href="g-computation-for-causal-inference.html#cb370-32" tabindex="-1"></a>              effect<span class="sc">$</span>risk_diff_ci[<span class="dv">1</span>] <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb370-33"><a href="g-computation-for-causal-inference.html#cb370-33" tabindex="-1"></a>              effect<span class="sc">$</span>risk_diff_ci[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb370-34"><a href="g-computation-for-causal-inference.html#cb370-34" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  Risk Ratio: %.2f (95%% CI: %.2f to %.2f)</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb370-35"><a href="g-computation-for-causal-inference.html#cb370-35" tabindex="-1"></a>              effect<span class="sc">$</span>risk_ratio_mean,</span>
<span id="cb370-36"><a href="g-computation-for-causal-inference.html#cb370-36" tabindex="-1"></a>              effect<span class="sc">$</span>risk_ratio_ci[<span class="dv">1</span>],</span>
<span id="cb370-37"><a href="g-computation-for-causal-inference.html#cb370-37" tabindex="-1"></a>              effect<span class="sc">$</span>risk_ratio_ci[<span class="dv">2</span>]))</span>
<span id="cb370-38"><a href="g-computation-for-causal-inference.html#cb370-38" tabindex="-1"></a>  </span>
<span id="cb370-39"><a href="g-computation-for-causal-inference.html#cb370-39" tabindex="-1"></a>  effect_summary <span class="ot">&lt;-</span> <span class="fu">rbind</span>(effect_summary, <span class="fu">data.frame</span>(</span>
<span id="cb370-40"><a href="g-computation-for-causal-inference.html#cb370-40" tabindex="-1"></a>    <span class="at">comparison =</span> <span class="fu">paste</span>(comp[<span class="dv">1</span>], <span class="st">&quot;vs&quot;</span>, comp[<span class="dv">2</span>]),</span>
<span id="cb370-41"><a href="g-computation-for-causal-inference.html#cb370-41" tabindex="-1"></a>    <span class="at">risk_diff =</span> effect<span class="sc">$</span>risk_diff_mean <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb370-42"><a href="g-computation-for-causal-inference.html#cb370-42" tabindex="-1"></a>    <span class="at">rd_lower =</span> effect<span class="sc">$</span>risk_diff_ci[<span class="dv">1</span>] <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb370-43"><a href="g-computation-for-causal-inference.html#cb370-43" tabindex="-1"></a>    <span class="at">rd_upper =</span> effect<span class="sc">$</span>risk_diff_ci[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb370-44"><a href="g-computation-for-causal-inference.html#cb370-44" tabindex="-1"></a>    <span class="at">risk_ratio =</span> effect<span class="sc">$</span>risk_ratio_mean,</span>
<span id="cb370-45"><a href="g-computation-for-causal-inference.html#cb370-45" tabindex="-1"></a>    <span class="at">rr_lower =</span> effect<span class="sc">$</span>risk_ratio_ci[<span class="dv">1</span>],</span>
<span id="cb370-46"><a href="g-computation-for-causal-inference.html#cb370-46" tabindex="-1"></a>    <span class="at">rr_upper =</span> effect<span class="sc">$</span>risk_ratio_ci[<span class="dv">2</span>]</span>
<span id="cb370-47"><a href="g-computation-for-causal-inference.html#cb370-47" tabindex="-1"></a>  ))</span>
<span id="cb370-48"><a href="g-computation-for-causal-inference.html#cb370-48" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## 
## never_treat vs always_treat:
##   Risk Difference: 38.82% (95% CI: 35.05% to 42.95%)
##   Risk Ratio: 2.58 (95% CI: 2.31 to 2.94)
## 
## never_treat vs threshold_strategy:
##   Risk Difference: 19.85% (95% CI: 15.59% to 24.46%)
##   Risk Ratio: 1.46 (95% CI: 1.34 to 1.59)
## 
## always_treat vs threshold_strategy:
##   Risk Difference: -18.97% (95% CI: -22.95% to -14.95%)
##   Risk Ratio: 0.57 (95% CI: 0.49 to 0.64)</code></pre>
</div>
<div id="interpreting-results-and-model-diagnostics" class="section level3 hasAnchor" number="11.2.2">
<h3><span class="header-section-number">11.2.2</span> Interpreting Results and Model Diagnostics<a href="g-computation-for-causal-inference.html#interpreting-results-and-model-diagnostics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The G-formula estimates reveal the causal effects of sustained treatment strategies by comparing counterfactual risks under different regimes. The key estimands include risk under each treatment regime representing the probability of cardiovascular events by five years if all patients followed that regime, risk differences quantifying absolute risk reduction from intensive treatment, and risk ratios providing relative measures of treatment benefit.</p>
<p>Beyond point estimates, we must evaluate model adequacy through diagnostic procedures. The <code>gfoRmula</code> package provides tools for assessing whether our parametric models adequately capture the data-generating process. Goodness-of-fit statistics for each covariate model indicate whether we correctly specified the functional form and included relevant predictors. Balance checks compare the simulated covariate distributions under the natural course to the observed distributions—large discrepancies suggest model misspecification.</p>
<p>Good agreement between observed and simulated blood pressure trajectories under the natural course provides evidence that our covariate models adequately capture the time-varying confounder process. Substantial deviations would suggest model misspecification requiring revision of functional forms, addition of interaction terms, or inclusion of additional predictors. The confidence intervals around regime-specific risks reflect bootstrap uncertainty, accounting for both sampling variability and estimation error in the fitted models.</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="g-computation-for-causal-inference.html#cb372-1" tabindex="-1"></a><span class="co"># Plot 1: Cumulative incidence trajectories with uncertainty</span></span>
<span id="cb372-2"><a href="g-computation-for-causal-inference.html#cb372-2" tabindex="-1"></a>risk_trajectories <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">names</span>(results), <span class="cf">function</span>(strategy) {</span>
<span id="cb372-3"><a href="g-computation-for-causal-inference.html#cb372-3" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb372-4"><a href="g-computation-for-causal-inference.html#cb372-4" tabindex="-1"></a>    <span class="at">time =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb372-5"><a href="g-computation-for-causal-inference.html#cb372-5" tabindex="-1"></a>    <span class="at">mean_risk =</span> results[[strategy]]<span class="sc">$</span>mean_risk_trajectory,</span>
<span id="cb372-6"><a href="g-computation-for-causal-inference.html#cb372-6" tabindex="-1"></a>    <span class="at">lower =</span> results[[strategy]]<span class="sc">$</span>mean_risk_trajectory <span class="sc">-</span> </span>
<span id="cb372-7"><a href="g-computation-for-causal-inference.html#cb372-7" tabindex="-1"></a>      <span class="fl">1.96</span> <span class="sc">*</span> results[[strategy]]<span class="sc">$</span>risk_trajectory_se,</span>
<span id="cb372-8"><a href="g-computation-for-causal-inference.html#cb372-8" tabindex="-1"></a>    <span class="at">upper =</span> results[[strategy]]<span class="sc">$</span>mean_risk_trajectory <span class="sc">+</span> </span>
<span id="cb372-9"><a href="g-computation-for-causal-inference.html#cb372-9" tabindex="-1"></a>      <span class="fl">1.96</span> <span class="sc">*</span> results[[strategy]]<span class="sc">$</span>risk_trajectory_se,</span>
<span id="cb372-10"><a href="g-computation-for-causal-inference.html#cb372-10" tabindex="-1"></a>    <span class="at">strategy =</span> strategy</span>
<span id="cb372-11"><a href="g-computation-for-causal-inference.html#cb372-11" tabindex="-1"></a>  )</span>
<span id="cb372-12"><a href="g-computation-for-causal-inference.html#cb372-12" tabindex="-1"></a>}))</span>
<span id="cb372-13"><a href="g-computation-for-causal-inference.html#cb372-13" tabindex="-1"></a></span>
<span id="cb372-14"><a href="g-computation-for-causal-inference.html#cb372-14" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(risk_trajectories, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean_risk <span class="sc">*</span> <span class="dv">100</span>, </span>
<span id="cb372-15"><a href="g-computation-for-causal-inference.html#cb372-15" tabindex="-1"></a>                                    <span class="at">color =</span> strategy, <span class="at">fill =</span> strategy)) <span class="sc">+</span></span>
<span id="cb372-16"><a href="g-computation-for-causal-inference.html#cb372-16" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb372-17"><a href="g-computation-for-causal-inference.html#cb372-17" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower <span class="sc">*</span> <span class="dv">100</span>, <span class="at">ymax =</span> upper <span class="sc">*</span> <span class="dv">100</span>), </span>
<span id="cb372-18"><a href="g-computation-for-causal-inference.html#cb372-18" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb372-19"><a href="g-computation-for-causal-inference.html#cb372-19" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb372-20"><a href="g-computation-for-causal-inference.html#cb372-20" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Cumulative CVD Incidence Under Different Treatment Strategies&quot;</span>,</span>
<span id="cb372-21"><a href="g-computation-for-causal-inference.html#cb372-21" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Mean ± 95% CI from 500 Monte Carlo simulations&quot;</span>,</span>
<span id="cb372-22"><a href="g-computation-for-causal-inference.html#cb372-22" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Time (years)&quot;</span>,</span>
<span id="cb372-23"><a href="g-computation-for-causal-inference.html#cb372-23" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Cumulative CVD Incidence (%)&quot;</span>,</span>
<span id="cb372-24"><a href="g-computation-for-causal-inference.html#cb372-24" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;Strategy&quot;</span>,</span>
<span id="cb372-25"><a href="g-computation-for-causal-inference.html#cb372-25" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;Strategy&quot;</span></span>
<span id="cb372-26"><a href="g-computation-for-causal-inference.html#cb372-26" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb372-27"><a href="g-computation-for-causal-inference.html#cb372-27" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb372-28"><a href="g-computation-for-causal-inference.html#cb372-28" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb372-29"><a href="g-computation-for-causal-inference.html#cb372-29" tabindex="-1"></a></span>
<span id="cb372-30"><a href="g-computation-for-causal-inference.html#cb372-30" tabindex="-1"></a><span class="fu">print</span>(p1)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-36-1.png" width="672" /></p>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb373-1"><a href="g-computation-for-causal-inference.html#cb373-1" tabindex="-1"></a><span class="co"># Plot 2: Risk differences with confidence intervals</span></span>
<span id="cb373-2"><a href="g-computation-for-causal-inference.html#cb373-2" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(effect_summary, <span class="fu">aes</span>(<span class="at">x =</span> comparison, <span class="at">y =</span> risk_diff)) <span class="sc">+</span></span>
<span id="cb373-3"><a href="g-computation-for-causal-inference.html#cb373-3" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">&quot;steelblue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb373-4"><a href="g-computation-for-causal-inference.html#cb373-4" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> rd_lower, <span class="at">ymax =</span> rd_upper), </span>
<span id="cb373-5"><a href="g-computation-for-causal-inference.html#cb373-5" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb373-6"><a href="g-computation-for-causal-inference.html#cb373-6" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb373-7"><a href="g-computation-for-causal-inference.html#cb373-7" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.1f%%&quot;</span>, risk_diff)), </span>
<span id="cb373-8"><a href="g-computation-for-causal-inference.html#cb373-8" tabindex="-1"></a>            <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span>) <span class="sc">+</span></span>
<span id="cb373-9"><a href="g-computation-for-causal-inference.html#cb373-9" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb373-10"><a href="g-computation-for-causal-inference.html#cb373-10" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Treatment Effects: Absolute Risk Reduction&quot;</span>,</span>
<span id="cb373-11"><a href="g-computation-for-causal-inference.html#cb373-11" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Risk difference with 95% confidence intervals&quot;</span>,</span>
<span id="cb373-12"><a href="g-computation-for-causal-inference.html#cb373-12" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb373-13"><a href="g-computation-for-causal-inference.html#cb373-13" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Risk Difference (percentage points)&quot;</span></span>
<span id="cb373-14"><a href="g-computation-for-causal-inference.html#cb373-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb373-15"><a href="g-computation-for-causal-inference.html#cb373-15" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb373-16"><a href="g-computation-for-causal-inference.html#cb373-16" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">15</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb373-17"><a href="g-computation-for-causal-inference.html#cb373-17" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(effect_summary<span class="sc">$</span>rd_lower) <span class="sc">*</span> <span class="fl">0.8</span>, </span>
<span id="cb373-18"><a href="g-computation-for-causal-inference.html#cb373-18" tabindex="-1"></a>                           <span class="fu">max</span>(effect_summary<span class="sc">$</span>rd_upper) <span class="sc">*</span> <span class="fl">1.2</span>))</span>
<span id="cb373-19"><a href="g-computation-for-causal-inference.html#cb373-19" tabindex="-1"></a></span>
<span id="cb373-20"><a href="g-computation-for-causal-inference.html#cb373-20" tabindex="-1"></a><span class="fu">print</span>(p2)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-36-2.png" width="672" /></p>
<div class="sourceCode" id="cb374"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb374-1"><a href="g-computation-for-causal-inference.html#cb374-1" tabindex="-1"></a><span class="co"># Plot 3: Risk ratios with confidence intervals</span></span>
<span id="cb374-2"><a href="g-computation-for-causal-inference.html#cb374-2" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(effect_summary, <span class="fu">aes</span>(<span class="at">x =</span> comparison, <span class="at">y =</span> risk_ratio)) <span class="sc">+</span></span>
<span id="cb374-3"><a href="g-computation-for-causal-inference.html#cb374-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">&quot;darkred&quot;</span>) <span class="sc">+</span></span>
<span id="cb374-4"><a href="g-computation-for-causal-inference.html#cb374-4" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> rr_lower, <span class="at">ymax =</span> rr_upper), </span>
<span id="cb374-5"><a href="g-computation-for-causal-inference.html#cb374-5" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">color =</span> <span class="st">&quot;darkred&quot;</span>) <span class="sc">+</span></span>
<span id="cb374-6"><a href="g-computation-for-causal-inference.html#cb374-6" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb374-7"><a href="g-computation-for-causal-inference.html#cb374-7" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb374-8"><a href="g-computation-for-causal-inference.html#cb374-8" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Treatment Effects: Relative Risk&quot;</span>,</span>
<span id="cb374-9"><a href="g-computation-for-causal-inference.html#cb374-9" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Risk ratio with 95% confidence intervals&quot;</span>,</span>
<span id="cb374-10"><a href="g-computation-for-causal-inference.html#cb374-10" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb374-11"><a href="g-computation-for-causal-inference.html#cb374-11" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Risk Ratio&quot;</span></span>
<span id="cb374-12"><a href="g-computation-for-causal-inference.html#cb374-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb374-13"><a href="g-computation-for-causal-inference.html#cb374-13" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb374-14"><a href="g-computation-for-causal-inference.html#cb374-14" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">15</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb374-15"><a href="g-computation-for-causal-inference.html#cb374-15" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(effect_summary<span class="sc">$</span>rr_upper) <span class="sc">*</span> <span class="fl">1.1</span>))</span>
<span id="cb374-16"><a href="g-computation-for-causal-inference.html#cb374-16" tabindex="-1"></a></span>
<span id="cb374-17"><a href="g-computation-for-causal-inference.html#cb374-17" tabindex="-1"></a><span class="fu">print</span>(p3)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-36-3.png" width="672" /></p>
<div class="sourceCode" id="cb375"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb375-1"><a href="g-computation-for-causal-inference.html#cb375-1" tabindex="-1"></a>best_strategy <span class="ot">&lt;-</span> <span class="fu">names</span>(results)[<span class="fu">which.min</span>(<span class="fu">sapply</span>(results, <span class="cf">function</span>(x) x<span class="sc">$</span>cumulative_incidence))]</span>
<span id="cb375-2"><a href="g-computation-for-causal-inference.html#cb375-2" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;- Best performing strategy: %s</span><span class="sc">\n</span><span class="st">&quot;</span>, best_strategy))</span></code></pre></div>
<pre><code>## - Best performing strategy: always_treat</code></pre>
<div class="sourceCode" id="cb377"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb377-1"><a href="g-computation-for-causal-inference.html#cb377-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;- 5-year CVD risk: %.1f%% (95%% CI: %.1f%%-%.1f%%)</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb377-2"><a href="g-computation-for-causal-inference.html#cb377-2" tabindex="-1"></a>            results[[best_strategy]]<span class="sc">$</span>cumulative_incidence <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb377-3"><a href="g-computation-for-causal-inference.html#cb377-3" tabindex="-1"></a>            <span class="fu">quantile</span>(results[[best_strategy]]<span class="sc">$</span>all_cumulative_incidence, <span class="fl">0.025</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb377-4"><a href="g-computation-for-causal-inference.html#cb377-4" tabindex="-1"></a>            <span class="fu">quantile</span>(results[[best_strategy]]<span class="sc">$</span>all_cumulative_incidence, <span class="fl">0.975</span>) <span class="sc">*</span> <span class="dv">100</span>))</span></code></pre></div>
<pre><code>## - 5-year CVD risk: 24.7% (95% CI: 21.9%-27.3%)</code></pre>
</div>
</div>
<div id="practical-considerations-and-limitations" class="section level2 hasAnchor" number="11.3">
<h2><span class="header-section-number">11.3</span> Practical Considerations and Limitations<a href="g-computation-for-causal-inference.html#practical-considerations-and-limitations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The true power of G-computation emerges when estimating effects of dynamic treatment regimes that adapt to patient status over time, mimicking realistic clinical decision-making where treatment intensification depends on evolving patient characteristics. Unlike static regimes that specify treatment at baseline, dynamic regimes specify treatment rules as functions of observed history.</p>
<p>Dynamic regimes enable answering clinically relevant questions such as whether treating based on blood pressure thresholds versus treating all patients yields better outcomes, what threshold should trigger treatment intensification for different patient subgroups, and how frequently monitoring should occur to implement threshold-based treatment rules effectively. The G-formula naturally accommodates such questions by simulating how blood pressure would evolve under different decision rules and computing resulting event rates.</p>
<p>Successful G-computation implementation requires attention to several practical considerations that determine whether the method provides valid causal estimates. Model specification represents the most critical challenge, as the method depends on correctly modeling the relationships between treatments, confounders, and outcomes. Unlike propensity score methods that can be robust to outcome model misspecification, G-computation requires accurate outcome and covariate models. However, this requirement is less stringent than it appears—models need not be perfectly specified, but must capture the essential relationships between variables. Including relevant interactions, nonlinear terms, and lagged variables typically suffices for adequate performance.</p>
<p>Sample size considerations become particularly important in longitudinal settings where we must fit separate models for each time-varying covariate. Small samples may not provide stable estimates, especially when treatment patterns are sparse or covariate distributions change substantially over time. As a rough guideline, longitudinal G-computation requires at least several hundred subjects with complete follow-up to provide reliable estimates, though exact requirements depend on the complexity of the data-generating process and number of time points.</p>
<p>The fundamental assumption of no unmeasured confounding cannot be empirically verified and requires substantive knowledge about the data-generating process. In observational hypertension studies, unmeasured factors like patient preferences, physician practice patterns, or health behaviors might influence both treatment decisions and cardiovascular outcomes. Sensitivity analyses examining how results change under various degrees of unmeasured confounding provide important context for causal conclusions, though G-computation itself does not resolve confounding from unmeasured variables.</p>
<p>Computational demands of bootstrap inference can become substantial in longitudinal settings with many time points and covariates. Each bootstrap iteration requires refitting all covariate models and outcome models, then simulating counterfactual trajectories for all subjects under each treatment regime. Parallel computing substantially reduces computation time, but researchers should expect hours rather than minutes for complex analyses with adequate bootstrap samples.</p>
<p>Model compatibility represents another consideration often overlooked in practice. When covariate models and outcome models make incompatible assumptions about the data-generating process, G-formula estimates may be biased even if individual models appear well-specified. For instance, if the blood pressure model assumes linear time trends but the outcome model includes nonlinear time effects, the simulated counterfactual trajectories may not accurately reflect how outcomes would evolve under different treatment regimes. Ensuring consistency across models requires careful consideration of functional forms and included covariates.</p>
<p>Recent methodological developments extend G-computation to increasingly complex settings that expand its practical applicability. Doubly robust estimation combines G-computation with inverse probability weighting, providing valid estimates if either the outcome model or the treatment model is correctly specified. This approach offers protection against model misspecification that purely model-based G-computation lacks, though at the cost of increased computational complexity and potentially wider confidence intervals.</p>
<p>Machine learning methods for G-computation replace parametric models with flexible algorithms like random forests, gradient boosting, or neural networks. These approaches can capture complex nonlinear relationships and interactions without requiring explicit specification, potentially improving performance when the true data-generating process differs substantially from parametric assumptions. However, machine learning G-computation requires careful attention to overfitting and may provide less stable estimates in moderate sample sizes, along with reduced interpretability compared to parametric approaches.</p>
<p>Targeted maximum likelihood estimation provides a more efficient alternative to standard G-computation by incorporating information from both the outcome and treatment models. This approach updates initial model-based estimates using clever weighting schemes that reduce bias and improve precision. The method has gained traction in epidemiology and biostatistics for settings where optimal efficiency matters, though implementation complexity exceeds standard G-computation.</p>
<p>Mediation analysis represents a natural application for G-computation, as the method’s explicit modeling of intermediate variables enables decomposition of total effects into direct and indirect pathways. For hypertension management, we might decompose the treatment effect into a direct effect not mediated by blood pressure reduction and an indirect effect operating through blood pressure control. Such decompositions provide mechanistic insights about how treatments produce their effects, guiding development of more effective interventions.</p>
</div>
<div id="conclusion-integrating-g-computation-into-practice" class="section level2 hasAnchor" number="11.4">
<h2><span class="header-section-number">11.4</span> Conclusion: Integrating G-Computation into Practice<a href="g-computation-for-causal-inference.html#conclusion-integrating-g-computation-into-practice" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>G-computation provides a powerful and flexible framework for causal inference from observational data, particularly excelling in longitudinal settings with time-varying treatments and confounders where traditional methods struggle. The method’s explicit modeling of the data-generating process enables estimation of effects under complex treatment regimes while providing interpretable insights about how treatments affect outcomes over time.</p>
<p>Our hypertension case study demonstrates practical implementation using the <code>gfoRmula</code> package, showing how to specify appropriate models, simulate counterfactual trajectories, and interpret results in clinically meaningful terms. The ability to compare static and dynamic treatment regimes enables answering questions directly relevant to clinical decision-making about when and how intensively to treat patients with evolving risk profiles.</p>
<p>Successful application requires careful attention to model specification, adequate sample sizes, and validation of modeling assumptions through diagnostic procedures. The method works best when researchers possess substantive knowledge about the causal structure underlying their data and can specify models that capture essential relationships between treatments, confounders, and outcomes. While G-computation demands more upfront modeling effort than some alternatives, it rewards that investment with estimates of causal effects under realistic treatment strategies that match how clinicians actually make decisions in practice.</p>
<p>The integration of G-computation with modern computational tools and machine learning methods continues expanding the frontier of what’s possible in causal inference from complex longitudinal data. As healthcare increasingly relies on observational electronic health records and registry data to inform treatment decisions, methods like G-computation that can extract valid causal conclusions from such data become essential tools for evidence-based medicine and precision healthcare delivery.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="targeted-maximum-likelihood-estimation-for-robust-causal-inference-in-healthcare.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="structural-equation-modeling-for-healthcare-research-unraveling-complex-causal-pathways.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/Kamran-Afzali/Bookdown_Causality/edit/main/11-G_Estimation.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": "https://github.com/Kamran-Afzali/Bookdown_Causality/blob/main/11-G_Estimation.Rmd",
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
